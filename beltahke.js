//ᴘᴏᴡᴇʀᴇᴅ ʙʏ ʙᴇʟᴛᴀʜ ᴛᴇᴄʜ ᴛᴇᴀᴍ.
CiJ1c2Ugc3RyaWN0IjsKCnZhciBfX2NyZWF0ZUJpbmRpbmcgPSB0aGlzICYmIHRoaXMuX19jcmVhdGVCaW5kaW5nIHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIG0sIGssIGsyKSB7CiBpZiAoazIgPT09IHVuZGVmaW5lZCkgewogazIgPSBrOwogfQogdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG0sIGspOwogaWYgKCFkZXNjIHx8ICgiZ2V0IiBpbiBkZXNjID8gIW0uX19lc01vZHVsZSA6IGRlc2Mud3JpdGFibGUgfHwgZGVzYy5jb25maWd1cmFibGUpKSB7CiBkZXNjID0gewogZW51bWVyYWJsZTogdHJ1ZSwKIGdldDogZnVuY3Rpb24gKCkgewogcmV0dXJuIG1ba107CiB9CiB9OwogfQogT2JqZWN0LmRlZmluZVByb3BlcnR5KG8sIGsyLCBkZXNjKTsKfSA6IGZ1bmN0aW9uIChvLCBtLCBrLCBrMikgewogaWYgKGsyID09PSB1bmRlZmluZWQpIHsKIGsyID0gazsKIH0KIG9bazJdID0gbVtrXTsKfSk7CnZhciBfX3NldE1vZHVsZURlZmF1bHQgPSB0aGlzICYmIHRoaXMuX19zZXRNb2R1bGVEZWZhdWx0IHx8IChPYmplY3QuY3JlYXRlID8gZnVuY3Rpb24gKG8sIHYpIHsKIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvLCAiZGVmYXVsdCIsIHsKIGVudW1lcmFibGU6IHRydWUsCiB2YWx1ZTogdgogfSk7Cn0gOiBmdW5jdGlvbiAobywgdikgewogb1siZGVmYXVsdCJdID0gdjsKfSk7CnZhciBfX2ltcG9ydFN0YXIgPSB0aGlzICYmIHRoaXMuX19pbXBvcnRTdGFyIHx8IGZ1bmN0aW9uIChtb2QpIHsKIGlmIChtb2QgJiYgbW9kLl9fZXNNb2R1bGUpIHsKIHJldHVybiBtb2Q7CiB9CiB2YXIgcmVzdWx0ID0ge307CiBpZiAobW9kICE9IG51bGwpIHsKIGZvciAodmFyIGsgaW4gbW9kKSBpZiAoayAhPT0gImRlZmF1bHQiICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChtb2QsIGspKSB7CiBfX2NyZWF0ZUJpbmRpbmcocmVzdWx0LCBtb2QsIGspOwogfQogfQogX19zZXRNb2R1bGVEZWZhdWx0KHJlc3VsdCwgbW9kKTsKIHJldHVybiByZXN1bHQ7Cn07CnZhciBfX2ltcG9ydERlZmF1bHQgPSB0aGlzICYmIHRoaXMuX19pbXBvcnREZWZhdWx0IHx8IGZ1bmN0aW9uIChtb2QpIHsKIHJldHVybiBtb2QgJiYgbW9kLl9fZXNNb2R1bGUgPyBtb2QgOiB7CiAiZGVmYXVsdCI6IG1vZAogfTsKfTsKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgewogdmFsdWU6IHRydWUKfSk7CmNvbnN0IGJhaWxleXNfMSA9IF9faW1wb3J0U3RhcihyZXF1aXJlKCJAd2hpc2tleXNvY2tldHMvYmFpbGV5cyIpKTsKY29uc3QgbG9nZ2VyXzEgPSBfX2ltcG9ydERlZmF1bHQocmVxdWlyZSgiQHdoaXNrZXlzb2NrZXRzL2JhaWxleXMvbGliL1V0aWxzL2xvZ2dlciIpKTsKY29uc3QgbG9nZ2VyID0gbG9nZ2VyXzEuZGVmYXVsdC5jaGlsZCh7fSk7CmxvZ2dlci5sZXZlbCA9ICdzaWxlbnQnOwpjb25zdCBwaW5vID0gcmVxdWlyZSgicGlubyIpOwpjb25zdCBheGlvcyA9IHJlcXVpcmUoJ2F4aW9zJyk7CmNvbnN0IHsgRGF0ZVRpbWUgfSA9IHJlcXVpcmUoJ2x1eG9uJyk7CmNvbnN0IGJvb21fMSA9IHJlcXVpcmUoIkBoYXBpL2Jvb20iKTsKY29uc3QgY29uZiA9IHJlcXVpcmUoIi4vc2V0Iik7CmxldCBmcyA9IHJlcXVpcmUoImZzLWV4dHJhIik7CmxldCBwYXRoID0gcmVxdWlyZSgicGF0aCIpOwpjb25zdCBGaWxlVHlwZSA9IHJlcXVpcmUoJ2ZpbGUtdHlwZScpOwpjb25zdCB7CiBTdGlja2VyLAogY3JlYXRlU3RpY2tlciwKIFN0aWNrZXJUeXBlcwp9ID0gcmVxdWlyZSgnd2Etc3RpY2tlci1mb3JtYXR0ZXInKTsKLy9pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnCmNvbnN0IHsKIHZlcmlmaWVyRXRhdEppZCwKIHJlY3VwZXJlckFjdGlvbkppZAp9ID0gcmVxdWlyZSgiLi9iZGQvYW50aWxpZW4iKTsKY29uc3QgewogYXRidmVyaWZpZXJFdGF0SmlkLAogYXRicmVjdXBlcmVyQWN0aW9uSmlkCn0gPSByZXF1aXJlKCIuL2JkZC9hbnRpYm90Iik7CmxldCBldnQgPSByZXF1aXJlKF9fZGlybmFtZSArICIva2VpenphaC9rZWl0aCIpOwpjb25zdCB7CiBpc1VzZXJCYW5uZWQsCiBhZGRVc2VyVG9CYW5MaXN0LAogcmVtb3ZlVXNlckZyb21CYW5MaXN0Cn0gPSByZXF1aXJlKCIuL2JkZC9iYW5Vc2VyIik7CmNvbnN0IHsKIGFkZEdyb3VwVG9CYW5MaXN0LAogaXNHcm91cEJhbm5lZCwKIHJlbW92ZUdyb3VwRnJvbUJhbkxpc3QKfSA9IHJlcXVpcmUoIi4vYmRkL2Jhbkdyb3VwIik7CmNvbnN0IHsKIGlzR3JvdXBPbmx5QWRtaW4sCiBhZGRHcm91cFRvT25seUFkbWluTGlzdCwKIHJlbW92ZUdyb3VwRnJvbU9ubHlBZG1pbkxpc3QKfSA9IHJlcXVpcmUoIi4vYmRkL29ubHlBZG1pbiIpOwovL2NvbnN0IC8ve2xvYWRDbWR9PXJlcXVpcmUoIi9rZWl6emFoL21lc2ZvbmN0aW9ucyIpCmxldCB7CiByZWFnaXIKfSA9IHJlcXVpcmUoX19kaXJuYW1lICsgIi9rZWl6emFoL2FwcCIpOwp2YXIgc2Vzc2lvbiA9IGNvbmYuc2Vzc2lvbi5yZXBsYWNlKC9CRUxUQUgtTUQ7Ozs9Pi9nLCAiIik7CmNvbnN0IHByZWZpeGUgPSBjb25mLlBSRUZJWEUgfHwgW107CgpyZXF1aXJlKCdkb3RlbnYnKS5jb25maWcoewogJ3BhdGgnOiAiLi9jb25maWcuZW52Igp9KTsKYXN5bmMgZnVuY3Rpb24gYXV0aGVudGlmaWNhdGlvbigpIHsKIHRyeSB7CiAvL2NvbnNvbGUubG9nKCJsZSBkYXRhICIrZGF0YSkKIGlmICghZnMuZXhpc3RzU3luYyhfX2Rpcm5hbWUgKyAiL2F1dGgvY3JlZHMuanNvbiIpKSB7CiBjb25zb2xlLmxvZygiY29ubmVjdGVkIHN1Y2Nlc3NmdWxseS4uLiIpOwogYXdhaXQgZnMud3JpdGVGaWxlU3luYyhfX2Rpcm5hbWUgKyAiL2F1dGgvY3JlZHMuanNvbiIsIGF0b2Ioc2Vzc2lvbiksICJ1dGY4Iik7CiAvL2NvbnNvbGUubG9nKHNlc3Npb24pCiB9IGVsc2UgaWYgKGZzLmV4aXN0c1N5bmMoX19kaXJuYW1lICsgIi9hdXRoL2NyZWRzLmpzb24iKSAmJiBzZXNzaW9uICE9ICJ6b2trIikgewogYXdhaXQgZnMud3JpdGVGaWxlU3luYyhfX2Rpcm5hbWUgKyAiL2F1dGgvY3JlZHMuanNvbiIsIGF0b2Ioc2Vzc2lvbiksICJ1dGY4Iik7CiB9CiB9IGNhdGNoIChlKSB7CiBjb25zb2xlLmxvZygiU2Vzc2lvbiBJbnZhbGlkICIgKyBlKTsKIHJldHVybjsKIH0KfQphdXRoZW50aWZpY2F0aW9uKCk7CjA7CmNvbnN0IHN0b3JlID0gYmFpbGV5c18xLm1ha2VJbk1lbW9yeVN0b3JlKHsKIGxvZ2dlcjogcGlubygpLmNoaWxkKHsKIGxldmVsOiAic2lsZW50IiwKIHN0cmVhbTogInN0b3JlIgogfSkKfSk7CnNldFRpbWVvdXQoKCkgPT4gewogYXN5bmMgZnVuY3Rpb24gbWFpbigpIHsKIDA7CiBjb25zdCB7CiB2ZXJzaW9uLAogaXNMYXRlc3QKIH0gPSBhd2FpdCBiYWlsZXlzXzEuZmV0Y2hMYXRlc3RCYWlsZXlzVmVyc2lvbigpOwogMDsKIGNvbnN0IHsKIHN0YXRlLAogc2F2ZUNyZWRzCiB9ID0gYXdhaXQgYmFpbGV5c18xLnVzZU11bHRpRmlsZUF1dGhTdGF0ZShfX2Rpcm5hbWUgKyAiL2F1dGgiKTsKIDA7CiBjb25zdCBzb2NrT3B0aW9ucyA9IHsKIHZlcnNpb24sCiBsb2dnZXI6IHBpbm8oewogbGV2ZWw6ICJzaWxlbnQiCiB9KSwKIGJyb3dzZXI6IFsnQkVMVEFILU1EJywgInNhZmFyaSIsICIxLjAuMCJdLAogcHJpbnRRUkluVGVybWluYWw6IHRydWUsCiBmaXJlSW5pdFF1ZXJpZXM6IGZhbHNlLAogc2hvdWxkU3luY0hpc3RvcnlNZXNzYWdlOiB0cnVlLAogZG93bmxvYWRIaXN0b3J5OiB0cnVlLAogc3luY0Z1bGxIaXN0b3J5OiB0cnVlLAogZ2VuZXJhdGVIaWdoUXVhbGl0eUxpbmtQcmV2aWV3OiB0cnVlLAogbWFya09ubGluZU9uQ29ubmVjdDogZmFsc2UsCiBrZWVwQWxpdmVJbnRlcnZhbE1zOiAzMF8wMDAsCiAvKiBhdXRoOiBzdGF0ZSovYXV0aDogewogY3JlZHM6IHN0YXRlLmNyZWRzLAogLyoqIGNhY2hpbmcgbWFrZXMgdGhlIHN0b3JlIGZhc3RlciB0byBzZW5kL3JlY3YgbWVzc2FnZXMgKi8KIGtleXM6IGJhaWxleXNfMS5tYWtlQ2FjaGVhYmxlU2lnbmFsS2V5U3RvcmUoc3RhdGUua2V5cywgbG9nZ2VyKQogfSwKIC8vLy8vLy8vLy8KIGdldE1lc3NhZ2U6IGFzeW5jIGtleSA9PiB7CiBpZiAoc3RvcmUpIHsKIGNvbnN0IG1zZyA9IGF3YWl0IHN0b3JlLmxvYWRNZXNzYWdlKGtleS5yZW1vdGVKaWQsIGtleS5pZCwgdW5kZWZpbmVkKTsKIHJldHVybiBtc2cubWVzc2FnZSB8fCB1bmRlZmluZWQ7CiB9CiByZXR1cm4gewogY29udmVyc2F0aW9uOiAnQW4gRXJyb3IgT2NjdXJyZWQsIFJlcGVhdCBDb21tYW5kIScKIH07CiB9CiAvLy8vLy8vCiB9OwoKIDA7CiBjb25zdCB6ayA9IGJhaWxleXNfMS5kZWZhdWx0KHNvY2tPcHRpb25zKTsKIHN0b3JlLmJpbmQoemsuZXYpOwogc2V0SW50ZXJ2YWwoKCkgPT4gewogc3RvcmUud3JpdGVUb0ZpbGUoInN0b3JlLmpzb24iKTsKIH0sIDMwMDApOwogY29uc3QgZGVsYXkgPSBtcyA9PiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTsKCi8vIFRyYWNrIHRoZSBsYXN0IHRleHQgdGltZSB0byBwcmV2ZW50IG92ZXJmbG93CmxldCBsYXN0VGV4dFRpbWUgPSAwOwpjb25zdCBtZXNzYWdlRGVsYXkgPSA1MDAwOyAvLyBTZXQgdGhlIG1pbmltdW0gZGVsYXkgYmV0d2VlbiBtZXNzYWdlcyAoaW4gbWlsbGlzZWNvbmRzKQoKemsuZXYub24oJ2NhbGwnLCBhc3luYyAoY2FsbERhdGEpID0+IHsKIGlmIChjb25mLkFOVElDQUxMID09PSAneWVzJykgewogY29uc3QgY2FsbElkID0gY2FsbERhdGFbMF0uaWQ7CiBjb25zdCBjYWxsZXJJZCA9IGNhbGxEYXRhWzBdLmZyb207CiAKIC8vIFJlamVjdCB0aGUgY2FsbAogYXdhaXQgemsucmVqZWN0Q2FsbChjYWxsSWQsIGNhbGxlcklkKTsKCiAvLyBDaGVjayBpZiBlbm91Z2ggdGltZSBoYXMgcGFzc2VkIHNpbmNlIHRoZSBsYXN0IG1lc3NhZ2UKIGNvbnN0IGN1cnJlbnRUaW1lID0gRGF0ZS5ub3coKTsKIGlmIChjdXJyZW50VGltZSAtIGxhc3RUZXh0VGltZSA+PSBtZXNzYWdlRGVsYXkpIHsKIC8vIFNlbmQgdGhlIHJlamVjdGlvbiBtZXNzYWdlIGlmIHRoZSBkZWxheSBoYXMgcGFzc2VkCiBhd2FpdCBjbGllbnQuc2VuZE1lc3NhZ2UoY2FsbGVySWQsIHsKIHRleHQ6IGNvbmYuQU5USUNBTExfTVNHCiB9KTsKCiAvLyBVcGRhdGUgdGhlIGxhc3QgdGV4dCB0aW1lCiBsYXN0VGV4dFRpbWUgPSBjdXJyZW50VGltZTsKIH0gZWxzZSB7CiBjb25zb2xlLmxvZygnTWVzc2FnZSBza2lwcGVkIHRvIHByZXZlbnQgb3ZlcmZsb3cnKTsKIH0KIH0KfSk7CiAvL0hhbmRsZSBzdGF0dXMgcmVhY3Rpb24gCiBjb25zdCBsb3ZlRW1vamlzID0gWyLinaTvuI8iLCAi8J+SliIsICLwn5KYIiwgIvCfkp0iLCAi8J+SkyIsICLwn5KMIiwgIvCfkpUiLCAi8J+YjiIsICLwn5SlIiwgIvCfkqUiLCAi8J+SryIsICLinKgiLCAi8J+MnyIsICLwn4yIIiwgIuKaoSIsICLwn5KOIiwgIvCfjIAiLCAi8J+RkSIsICLwn46JIiwgIvCfjooiLCAi8J+mhCIsICLwn5G9IiwgIvCfm7giLCAKICLwn5qAIiwgIvCfposiLCAi8J+SqyIsICLwn42AIiwgIvCfjrYiLCAi8J+OpyIsICLwn464IiwgIvCfjqQiLCAi8J+PhiIsICLwn4+FIiwgIvCfjI0iLCAi8J+MjiIsICLwn4yPIiwgIvCfjq4iLCAi8J+OsiIsICLwn5KqIiwgCiAi8J+Pi++4jyIsICLwn6WHIiwgIvCfkZ8iLCAi8J+PgyIsICLwn5q0IiwgIvCfmrYiLCAi8J+PhCIsICLim7fvuI8iLCAi8J+Vtu+4jyIsICLwn6ezIiwgIvCfjb8iLCAi8J+NvyIsICLwn6WCIiwgIvCfjbsiLCAi8J+NtyIsICLwn424IiwgCiAi8J+lgyIsICLwn42+IiwgIvCfjq8iLCAi4o+zIiwgIvCfjoEiLCAi8J+OiCIsICLwn46oIiwgIvCfjLsiLCAi8J+MuCIsICLwn4y6IiwgIvCfjLkiLCAi8J+MvCIsICLwn4yeIiwgIvCfjJ0iLCAi8J+MnCIsICLwn4yZIiwgCiAi8J+MmiIsICLwn42AIiwgIvCfjLEiLCAi8J+NgyIsICLwn42CIiwgIvCfjL4iLCAi8J+QiSIsICLwn5CNIiwgIvCfppMiLCAi8J+mhCIsICLwn6aLIiwgIvCfpqciLCAi8J+mmCIsICLwn6aoIiwgIvCfpqEiLCAi8J+QiSIsIAogIvCfkIUiLCAi8J+QhiIsICLwn5CTIiwgIvCfkKIiLCAi8J+QiiIsICLwn5CgIiwgIvCfkJ8iLCAi8J+QoSIsICLwn6aRIiwgIvCfkJkiLCAi8J+mgCIsICLwn5CsIiwgIvCfppUiLCAi8J+mliIsICLwn5C+IiwgIvCfkJUiLCAKICLwn5CIIiwgIvCfkIciLCAi8J+QviJdOwoKCmxldCBsYXN0UmVhY3Rpb25UaW1lID0gMDsKCmlmIChjb25mLkFVVE9fTElLRV9TVEFUVVMgPT09ICJ5ZXMiKSB7CiBjb25zb2xlLmxvZygiQVVUT19MSUtFX1NUQVRVUyBpcyBlbmFibGVkLiBMaXN0ZW5pbmcgZm9yIHN0YXR1cyB1cGRhdGVzLi4uIik7CgogemsuZXYub24oIm1lc3NhZ2VzLnVwc2VydCIsIGFzeW5jIChtKSA9PiB7CiBjb25zdCB7IG1lc3NhZ2VzIH0gPSBtOwoKIGZvciAoY29uc3QgbWVzc2FnZSBvZiBtZXNzYWdlcykgewogLy8gQ2hlY2sgaWYgdGhlIG1lc3NhZ2UgaXMgYSBzdGF0dXMgdXBkYXRlCiBpZiAobWVzc2FnZS5rZXkgJiYgbWVzc2FnZS5rZXkucmVtb3RlSmlkID09PSAic3RhdHVzQGJyb2FkY2FzdCIpIHsKIGNvbnNvbGUubG9nKCJEZXRlY3RlZCBzdGF0dXMgdXBkYXRlIGZyb206IiwgbWVzc2FnZS5rZXkucmVtb3RlSmlkKTsKCiAvLyBFbnN1cmUgdGhyb3R0bGluZyBieSBjaGVja2luZyB0aGUgbGFzdCByZWFjdGlvbiB0aW1lCiBjb25zdCBub3cgPSBEYXRlLm5vdygpOwogaWYgKG5vdyAtIGxhc3RSZWFjdGlvblRpbWUgPCA1MDAwKSB7IC8vIDUtc2Vjb25kIGludGVydmFsCiBjb25zb2xlLmxvZygiVGhyb3R0bGluZyByZWFjdGlvbnMgdG8gcHJldmVudCBvdmVyZmxvdy4iKTsKIGNvbnRpbnVlOwogfQoKIC8vIENoZWNrIGlmIGJvdCB1c2VyIElEIGlzIGF2YWlsYWJsZQogY29uc3QgYmVsdGFoID0gemsudXNlciAmJiB6ay51c2VyLmlkID8gemsudXNlci5pZC5zcGxpdCgiOiIpWzBdICsgIkBzLndoYXRzYXBwLm5ldCIgOiBudWxsOwogaWYgKCFiZWx0YWgpIHsKIGNvbnNvbGUubG9nKCJCb3QncyB1c2VyIElEIG5vdCBhdmFpbGFibGUuIFNraXBwaW5nIHJlYWN0aW9uLiIpOwogY29udGludWU7CiB9CgogLy8gU2VsZWN0IGEgcmFuZG9tIGxvdmUgZW1vamkKIGNvbnN0IHJhbmRvbUxvdmVFbW9qaSA9IGxvdmVFbW9qaXNbTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbG92ZUVtb2ppcy5sZW5ndGgpXTsKCiAvLyBSZWFjdCB0byB0aGUgc3RhdHVzIHdpdGggdGhlIHNlbGVjdGVkIGxvdmUgZW1vamkKIHRyeSB7CiBhd2FpdCB6ay5zZW5kTWVzc2FnZShtZXNzYWdlLmtleS5yZW1vdGVKaWQsIHsKIHJlYWN0OiB7CiBrZXk6IG1lc3NhZ2Uua2V5LAogdGV4dDogcmFuZG9tTG92ZUVtb2ppLCAvLyBSZWFjdGlvbiBlbW9qaQogfSwKIH0sIHsKIHN0YXR1c0ppZExpc3Q6IFttZXNzYWdlLmtleS5wYXJ0aWNpcGFudF0sIC8vIEFkZCBvdGhlciBwYXJ0aWNpcGFudHMgaWYgbmVlZGVkCiB9KTsKCiAvLyBMb2cgc3VjY2Vzc2Z1bCByZWFjdGlvbiBhbmQgdXBkYXRlIHRoZSBsYXN0IHJlYWN0aW9uIHRpbWUKIGxhc3RSZWFjdGlvblRpbWUgPSBEYXRlLm5vdygpOwogY29uc29sZS5sb2coYFN1Y2Nlc3NmdWxseSByZWFjdGVkIHRvIHN0YXR1cyB1cGRhdGUgYnkgJHttZXNzYWdlLmtleS5yZW1vdGVKaWR9IHdpdGggJHtyYW5kb21Mb3ZlRW1vaml9YCk7CgogLy8gRGVsYXkgdG8gYXZvaWQgcmFwaWQgcmVhY3Rpb25zCiBhd2FpdCBkZWxheSgyMDAwKTsgLy8gMi1zZWNvbmQgZGVsYXkgYmV0d2VlbiByZWFjdGlvbnMKIH0gY2F0Y2ggKGVycm9yKSB7CiBjb25zb2xlLmVycm9yKCdFcnJvciByZWFjdGluZyB0byBzdGF0dXMgdXBkYXRlOicsIGVycm9yKTsKIH0KIH0KIH0KIH0pOwp9CgogLy9oYW5kbGUgYXV0b2JpbwppZiAoY29uZi5BVVRPQklPID09PSAneWVzJykgewogc2V0SW50ZXJ2YWwoKCkgPT4gewogY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCk7CiB6ay51cGRhdGVQcm9maWxlU3RhdHVzKAogYPCfkbsgJHtjb25mLkJPVH0g8J+RuyB8fCDwnZCD8J2QmvCdkK3wnZCeOiAke2RhdGUudG9Mb2NhbGVTdHJpbmcoJ2VuLVVTJyAsIHsgdGltZVpvbmU6ICdBZnJpY2EvTmFpcm9iaScgfSl9IHx8IPCdkIPwnZCa8J2QsjogJHtkYXRlLnRvTG9jYWxlU3RyaW5nKCdlbi1VUycsIHsgd2Vla2RheTogJ2xvbmcnLCB0aW1lWm9uZTogJ0FmcmljYS9OYWlyb2JpJyB9KX0uYAogKTsKIH0sIDEwICogMTAwMCk7CiB9CiAKIGxldCByZXBsaWVkQ29udGFjdHMgPSBuZXcgU2V0KCk7Cgp6ay5ldi5vbigibWVzc2FnZXMudXBzZXJ0IiwgYXN5bmMgKG0pID0+IHsKIGNvbnN0IHsgbWVzc2FnZXMgfSA9IG07CiBjb25zdCBtcyA9IG1lc3NhZ2VzWzBdOwogaWYgKCFtcy5tZXNzYWdlKSB7CiByZXR1cm47CiB9CgogY29uc3QgbWVzc2FnZVRleHQgPSBtcy5tZXNzYWdlLmNvbnZlcnNhdGlvbiB8fCBtcy5tZXNzYWdlLmV4dGVuZGVkVGV4dE1lc3NhZ2U/LnRleHQgfHwgIiI7CiBjb25zdCByZW1vdGVKaWQgPSBtcy5rZXkucmVtb3RlSmlkOwogY29uc3Qgc2VuZGVyTnVtYmVyID0gcmVtb3RlSmlkLnNwbGl0KCdAJylbMF07CgogLy8gRGVmYXVsdCBhdXRvLXJlcGx5IG1lc3NhZ2UKIGxldCBhdXRvX3JlcGx5X21lc3NhZ2UgPSBgSGVsbG8gQCR7c2VuZGVyTnVtYmVyfSwgJHtjb25mLk9XTkVSX05BTUV9IGlzIHVuYXZhaWxhYmxlIHJpZ2h0IG5vdy4gS2luZGx5IGxlYXZlIGEgbWVzc2FnZS5gOwoKIC8vIENoZWNrIGlmIHRoZSBtZXNzYWdlIGV4aXN0cyBhbmQgaXMgYSBjb21tYW5kIHRvIHNldCBhIG5ldyBhdXRvLXJlcGx5IG1lc3NhZ2UKIGlmIChtZXNzYWdlVGV4dC5zdGFydHNXaXRoKCc+JykgJiYgbXMua2V5LmZyb21NZSkgewogY29uc3QgY29tbWFuZCA9IG1lc3NhZ2VUZXh0LnNsaWNlKDEpLnNwbGl0KCIgIilbMF07IC8vIENvbW1hbmQgYWZ0ZXIgcHJlZml4CiBjb25zdCBuZXdNZXNzYWdlID0gbWVzc2FnZVRleHQuc2xpY2UoY29tbWFuZC5sZW5ndGggKyAyKS50cmltKCk7IC8vIE5ldyBtZXNzYWdlIGNvbnRlbnQKCiAvLyBVcGRhdGUgdGhlIGF1dG8tcmVwbHkgbWVzc2FnZSBpZiB0aGUgY29tbWFuZCBpcyAnc2V0YXV0b3JlcGx5JwogaWYgKGNvbW1hbmQgPT09ICJzZXRhdXRvcmVwbHkiICYmIG5ld01lc3NhZ2UpIHsKIGF1dG9fcmVwbHlfbWVzc2FnZSA9IG5ld01lc3NhZ2U7CiBhd2FpdCB6ay5zZW5kTWVzc2FnZShyZW1vdGVKaWQsIHsKIHRleHQ6IGBBdXRvLXJlcGx5IG1lc3NhZ2UgaGFzIGJlZW4gdXBkYXRlZCB0bzpcbiIke2F1dG9fcmVwbHlfbWVzc2FnZX0iYAogfSk7CiByZXR1cm47CiB9CiB9CgogLy8gQ2hlY2sgaWYgYXV0by1yZXBseSBpcyBlbmFibGVkLCBjb250YWN0IGhhc24ndCByZWNlaXZlZCBhIHJlcGx5LCBhbmQgaXQncyBhIHByaXZhdGUgY2hhdAogaWYgKGNvbmYuR1JFRVQgPT09ICJ5ZXMiICYmICFyZXBsaWVkQ29udGFjdHMuaGFzKHJlbW90ZUppZCkgJiYgIW1zLmtleS5mcm9tTWUgJiYgIXJlbW90ZUppZC5pbmNsdWRlcygiQGcudXMiKSkgewogYXdhaXQgemsuc2VuZE1lc3NhZ2UocmVtb3RlSmlkLCB7CiB0ZXh0OiBhdXRvX3JlcGx5X21lc3NhZ2UsCiBtZW50aW9uczogW3JlbW90ZUppZF0KIH0pOwoKIC8vIEFkZCBjb250YWN0IHRvIHJlcGxpZWQgc2V0IHRvIHByZXZlbnQgcmVwZWF0IHJlcGxpZXMKIHJlcGxpZWRDb250YWN0cy5hZGQocmVtb3RlSmlkKTsKIH0KfSk7CiAKIC8vIEZ1bmN0aW9uIHRvIGZvcm1hdCBub3RpZmljYXRpb24gbWVzc2FnZQpmdW5jdGlvbiBjcmVhdGVOb3RpZmljYXRpb24oZGVsZXRlZE1lc3NhZ2UpIHsKIGNvbnN0IGRlbGV0ZWRCeSA9IGRlbGV0ZWRNZXNzYWdlLmtleS5wYXJ0aWNpcGFudCB8fCBkZWxldGVkTWVzc2FnZS5rZXkucmVtb3RlSmlkOwogcmV0dXJuIGAq44COIPCfkbsgJHtjb25mLkJPVH0g4bSAybThtJvJquG0heG0h8qf4bSH4bSb4bSHIPCfkbsg44CPKlxuXG5gICsKIGAq4bSF4bSHyp/htIfhtJvJquG0j8m0IOG0m8mq4bSN4bSHOiogJHtuZXcgRGF0ZSgpLnRvTG9jYWxlU3RyaW5nKCl9XG5gICsKIGAq4bSF4bSHyp/htIfhtJvhtIfhtIUgypnKjzoqIEAke2RlbGV0ZWRCeS5zcGxpdCgnQCcpWzBdfVxuXG4+IOG0heG0h8qf4bSH4bSb4bSH4bSFIMmqybTSk+G0j8qA4bSN4bSA4bSbyarhtI/JtCDKgOG0h+G0m8qAyarhtIfhtKDhtIfhtIUgypnKjyDKmeG0h8qf4bSb4bSAypwt4bSN4bSFYDsKfQovLyBIZWxwZXIgZnVuY3Rpb24gdG8gZG93bmxvYWQgbWVkaWEgYmFzZWQgb24gbWVzc2FnZSB0eXBlCmFzeW5jIGZ1bmN0aW9uIGRvd25sb2FkTWVzc2FnZU1lZGlhKG1lc3NhZ2UpIHsKIGlmIChtZXNzYWdlLmltYWdlTWVzc2FnZSkgcmV0dXJuIGF3YWl0IGRvd25sb2FkTWVkaWEobWVzc2FnZS5pbWFnZU1lc3NhZ2UpOwogaWYgKG1lc3NhZ2UudmlkZW9NZXNzYWdlKSByZXR1cm4gYXdhaXQgZG93bmxvYWRNZWRpYShtZXNzYWdlLnZpZGVvTWVzc2FnZSk7CiBpZiAobWVzc2FnZS5kb2N1bWVudE1lc3NhZ2UpIHJldHVybiBhd2FpdCBkb3dubG9hZE1lZGlhKG1lc3NhZ2UuZG9jdW1lbnRNZXNzYWdlKTsKIGlmIChtZXNzYWdlLmF1ZGlvTWVzc2FnZSkgcmV0dXJuIGF3YWl0IGRvd25sb2FkTWVkaWEobWVzc2FnZS5hdWRpb01lc3NhZ2UpOwogaWYgKG1lc3NhZ2Uuc3RpY2tlck1lc3NhZ2UpIHJldHVybiBhd2FpdCBkb3dubG9hZE1lZGlhKG1lc3NhZ2Uuc3RpY2tlck1lc3NhZ2UpOwogaWYgKG1lc3NhZ2Uudm9pY2VNZXNzYWdlKSByZXR1cm4gYXdhaXQgZG93bmxvYWRNZWRpYShtZXNzYWdlLnZvaWNlTWVzc2FnZSk7CiByZXR1cm4gbnVsbDsKfQoKLy8gRXZlbnQgbGlzdGVuZXIgZm9yIGFsbCBpbmNvbWluZyBtZXNzYWdlcwp6ay5ldi5vbigibWVzc2FnZXMudXBzZXJ0IiwgYXN5bmMgbSA9PiB7CiAvLyBDaGVjayBpZiBBTlRJREVMRVRFIGlzIGVuYWJsZWQKIGlmIChjb25mLkFETSAhPT0gInllcyIpIHJldHVybjsKIGNvbnN0IHsgbWVzc2FnZXMgfSA9IG07CiBjb25zdCBtcyA9IG1lc3NhZ2VzWzBdOwogaWYgKCFtcy5tZXNzYWdlKSByZXR1cm47CgogY29uc3QgbWVzc2FnZUtleSA9IG1zLmtleTsKIGNvbnN0IHJlbW90ZUppZCA9IG1lc3NhZ2VLZXkucmVtb3RlSmlkOwogLy8gU3RvcmUgcmVjZWl2ZWQgbWVzc2FnZXMgZm9yIGZ1dHVyZSB1bmRlbGV0ZSByZWZlcmVuY2UKIGlmICghc3RvcmUuY2hhdHNbcmVtb3RlSmlkXSkgewogc3RvcmUuY2hhdHNbcmVtb3RlSmlkXSA9IFtdOwogfQogc3RvcmUuY2hhdHNbcmVtb3RlSmlkXS5wdXNoKG1zKTsKIC8vIEhhbmRsZSBkZWxldGVkIG1lc3NhZ2VzCiBpZiAobXMubWVzc2FnZS5wcm90b2NvbE1lc3NhZ2UgJiYgbXMubWVzc2FnZS5wcm90b2NvbE1lc3NhZ2UudHlwZSA9PT0gMCkgewogY29uc3QgZGVsZXRlZEtleSA9IG1zLm1lc3NhZ2UucHJvdG9jb2xNZXNzYWdlLmtleTsKIC8vIFNlYXJjaCBmb3IgdGhlIGRlbGV0ZWQgbWVzc2FnZSBpbiB0aGUgc3RvcmVkIG1lc3NhZ2VzCiBjb25zdCBjaGF0TWVzc2FnZXMgPSBzdG9yZS5jaGF0c1tyZW1vdGVKaWRdOwogY29uc3QgZGVsZXRlZE1lc3NhZ2UgPSBjaGF0TWVzc2FnZXMuZmluZChtc2cgPT4gbXNnLmtleS5pZCA9PT0gZGVsZXRlZEtleS5pZCk7CiAKIGlmIChkZWxldGVkTWVzc2FnZSkgewogdHJ5IHsKIC8vIENyZWF0ZSBub3RpZmljYXRpb24gYWJvdXQgdGhlIGRlbGV0ZWQgbWVzc2FnZQogY29uc3Qgbm90aWZpY2F0aW9uID0gY3JlYXRlTm90aWZpY2F0aW9uKGRlbGV0ZWRNZXNzYWdlKTsKIC8vIENoZWNrIGlmIHRoZSBkZWxldGVkIG1lc3NhZ2UgaXMgYSB0ZXh0IG1lc3NhZ2UKIGlmIChkZWxldGVkTWVzc2FnZS5tZXNzYWdlLmNvbnZlcnNhdGlvbikgewogYXdhaXQgemsuc2VuZE1lc3NhZ2UocmVtb3RlSmlkLCB7CiB0ZXh0OiBgJHtub3RpZmljYXRpb259XG5cbirhtIXhtIfKn+G0h+G0m+G0h+G0hSDhtI3htIdzc+G0gMmi4bSHOiogJHtkZWxldGVkTWVzc2FnZS5tZXNzYWdlLmNvbnZlcnNhdGlvbn1gLAogbWVudGlvbnM6IFtkZWxldGVkTWVzc2FnZS5rZXkucGFydGljaXBhbnRdCiB9KTsKIH0KIAogLy8gSGFuZGxlIG1lZGlhIG1lc3NhZ2VzIChpbWFnZSwgdmlkZW8sIGRvY3VtZW50LCBhdWRpbywgc3RpY2tlciwgdm9pY2UpCiBlbHNlIHsKIGNvbnN0IG1lZGlhQnVmZmVyID0gYXdhaXQgZG93bmxvYWRNZXNzYWdlTWVkaWEoZGVsZXRlZE1lc3NhZ2UubWVzc2FnZSk7CiBpZiAobWVkaWFCdWZmZXIpIHsKIGNvbnN0IG1lZGlhVHlwZSA9IGRlbGV0ZWRNZXNzYWdlLm1lc3NhZ2UuaW1hZ2VNZXNzYWdlID8gJ2ltYWdlJyA6CiBkZWxldGVkTWVzc2FnZS5tZXNzYWdlLnZpZGVvTWVzc2FnZSA/ICd2aWRlbycgOgogZGVsZXRlZE1lc3NhZ2UubWVzc2FnZS5kb2N1bWVudE1lc3NhZ2UgPyAnZG9jdW1lbnQnIDoKIGRlbGV0ZWRNZXNzYWdlLm1lc3NhZ2UuYXVkaW9NZXNzYWdlID8gJ2F1ZGlvJyA6CiBkZWxldGVkTWVzc2FnZS5tZXNzYWdlLnN0aWNrZXJNZXNzYWdlID8gJ3N0aWNrZXInIDogJ2F1ZGlvJzsKIGF3YWl0IHprLnNlbmRNZXNzYWdlKHJlbW90ZUppZCwgewogW21lZGlhVHlwZV06IG1lZGlhQnVmZmVyLAogY2FwdGlvbjogbm90aWZpY2F0aW9uLAogbWVudGlvbnM6IFtkZWxldGVkTWVzc2FnZS5rZXkucGFydGljaXBhbnRdCiB9KTsKIH0KIH0KIH0gY2F0Y2ggKGVycm9yKSB7CiBjb25zb2xlLmVycm9yKCdFcnJvciBoYW5kbGluZyBkZWxldGVkIG1lc3NhZ2U6JywgZXJyb3IpOwogfQogfQogfQp9KTsKIAogemsuZXYub24oIm1lc3NhZ2VzLnVwc2VydCIsIGFzeW5jIG0gPT4gewogY29uc3QgewogbWVzc2FnZXMKIH0gPSBtOwogY29uc3QgbXMgPSBtZXNzYWdlc1swXTsKIGlmICghbXMubWVzc2FnZSkgewogcmV0dXJuOwogfQogY29uc3QgZGVjb2RlSmlkID0gamlkID0+IHsKIGlmICghamlkKSB7CiByZXR1cm4gamlkOwogfQogaWYgKC86XGQrQC9naS50ZXN0KGppZCkpIHsKIDA7CiBsZXQgZGVjb2RlID0gYmFpbGV5c18xLmppZERlY29kZShqaWQpIHx8IHt9OwogcmV0dXJuIGRlY29kZS51c2VyICYmIGRlY29kZS5zZXJ2ZXIgJiYgZGVjb2RlLnVzZXIgKyAnQCcgKyBkZWNvZGUuc2VydmVyIHx8IGppZDsKIH0gZWxzZSB7CiByZXR1cm4gamlkOwogfQogfTsKIDA7CiB2YXIgbXR5cGUgPSBiYWlsZXlzXzEuZ2V0Q29udGVudFR5cGUobXMubWVzc2FnZSk7CiB2YXIgdGV4dGUgPSBtdHlwZSA9PSAiY29udmVyc2F0aW9uIiA/IG1zLm1lc3NhZ2UuY29udmVyc2F0aW9uIDogbXR5cGUgPT0gImltYWdlTWVzc2FnZSIgPyBtcy5tZXNzYWdlLmltYWdlTWVzc2FnZT8uY2FwdGlvbiA6IG10eXBlID09ICJ2aWRlb01lc3NhZ2UiID8gbXMubWVzc2FnZS52aWRlb01lc3NhZ2U/LmNhcHRpb24gOiBtdHlwZSA9PSAiZXh0ZW5kZWRUZXh0TWVzc2FnZSIgPyBtcy5tZXNzYWdlPy5leHRlbmRlZFRleHRNZXNzYWdlPy50ZXh0IDogbXR5cGUgPT0gImJ1dHRvbnNSZXNwb25zZU1lc3NhZ2UiID8gbXM/Lm1lc3NhZ2U/LmJ1dHRvbnNSZXNwb25zZU1lc3NhZ2U/LnNlbGVjdGVkQnV0dG9uSWQgOiBtdHlwZSA9PSAibGlzdFJlc3BvbnNlTWVzc2FnZSIgPyBtcy5tZXNzYWdlPy5saXN0UmVzcG9uc2VNZXNzYWdlPy5zaW5nbGVTZWxlY3RSZXBseT8uc2VsZWN0ZWRSb3dJZCA6IG10eXBlID09ICJtZXNzYWdlQ29udGV4dEluZm8iID8gbXM/Lm1lc3NhZ2U/LmJ1dHRvbnNSZXNwb25zZU1lc3NhZ2U/LnNlbGVjdGVkQnV0dG9uSWQgfHwgbXMubWVzc2FnZT8ubGlzdFJlc3BvbnNlTWVzc2FnZT8uc2luZ2xlU2VsZWN0UmVwbHk/LnNlbGVjdGVkUm93SWQgfHwgbXMudGV4dCA6ICIiOwogdmFyIG9yaWdpbmVNZXNzYWdlID0gbXMua2V5LnJlbW90ZUppZDsKIHZhciBpZEJvdCA9IGRlY29kZUppZCh6ay51c2VyLmlkKTsKIHZhciBzZXJ2Qm90ID0gaWRCb3Quc3BsaXQoJ0AnKVswXTsKIGNvbnN0IHZlcmlmR3JvdXBlID0gb3JpZ2luZU1lc3NhZ2U/LmVuZHNXaXRoKCJAZy51cyIpOwogdmFyIGluZm9zR3JvdXBlID0gdmVyaWZHcm91cGUgPyBhd2FpdCB6ay5ncm91cE1ldGFkYXRhKG9yaWdpbmVNZXNzYWdlKSA6ICIiOwogdmFyIG5vbUdyb3VwZSA9IHZlcmlmR3JvdXBlID8gaW5mb3NHcm91cGUuc3ViamVjdCA6ICIiOwogdmFyIG1zZ1JlcG9uZHUgPSBtcy5tZXNzYWdlLmV4dGVuZGVkVGV4dE1lc3NhZ2U/LmNvbnRleHRJbmZvPy5xdW90ZWRNZXNzYWdlOwogdmFyIGF1dGV1ck1zZ1JlcG9uZHUgPSBkZWNvZGVKaWQobXMubWVzc2FnZT8uZXh0ZW5kZWRUZXh0TWVzc2FnZT8uY29udGV4dEluZm8/LnBhcnRpY2lwYW50KTsKIHZhciBhdXRldXJNZXNzYWdlID0gdmVyaWZHcm91cGUgPyBtcy5rZXkucGFydGljaXBhbnQgPyBtcy5rZXkucGFydGljaXBhbnQgOiBtcy5wYXJ0aWNpcGFudCA6IG9yaWdpbmVNZXNzYWdlOwogaWYgKG1zLmtleS5mcm9tTWUpIHsKIGF1dGV1ck1lc3NhZ2UgPSBpZEJvdDsKIH0KIHZhciBtZW1icmVHcm91cGUgPSB2ZXJpZkdyb3VwZSA/IG1zLmtleS5wYXJ0aWNpcGFudCA6ICcnOwogY29uc3QgewogZ2V0QWxsU3Vkb051bWJlcnMKIH0gPSByZXF1aXJlKCIuL2JkZC9zdWRvIik7CiBjb25zdCBub21BdXRldXJNZXNzYWdlID0gbXMucHVzaE5hbWU7CiBjb25zdCBzdWRvID0gYXdhaXQgZ2V0QWxsU3Vkb051bWJlcnMoKTsKIGNvbnN0IHN1cGVyVXNlck51bWJlcnMgPSBbc2VydkJvdCwgIjI1NDczNzY4MTc1OCIsICcyNTQxMTQxNDExOTInLCIyNTQ3Mzg2MjU4MjciLCIyNTQ3NTkzMjg1ODEiLCBjb25mLk5VTUVST19PV05FUl0ubWFwKHMgPT4gcy5yZXBsYWNlKC9bXjAtOV0vZykgKyAiQHMud2hhdHNhcHAubmV0Iik7CiBjb25zdCBhbGxBbGxvd2VkTnVtYmVycyA9IHN1cGVyVXNlck51bWJlcnMuY29uY2F0KHN1ZG8pOwogY29uc3Qgc3VwZXJVc2VyID0gYWxsQWxsb3dlZE51bWJlcnMuaW5jbHVkZXMoYXV0ZXVyTWVzc2FnZSk7CiB2YXIgZGV2ID0gWycyNTQxMTQxNDExOTInLCIyNTQ3Mzc2ODE3NTgiLCIyNTQ3NTkzMjg1ODEiLCcyNTQ3Mzg2MjU4MjcnXS5tYXAodCA9PiB0LnJlcGxhY2UoL1teMC05XS9nKSArICJAcy53aGF0c2FwcC5uZXQiKS5pbmNsdWRlcyhhdXRldXJNZXNzYWdlKTsKIGZ1bmN0aW9uIHJlcG9uZHJlKG1lcykgewogemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsKIHRleHQ6IG1lcwogfSwgewogcXVvdGVkOiBtcwogfSk7CiB9CiBjb25zb2xlLmxvZygiXHQgW11bXS4uLntCZWx0YWgtTWR9Li4uW11bXSIpOwogY29uc29sZS5sb2coIj09PT09PT09PT09IE5ldyBtZXNzYWdlID09PT09PT09PT09Iik7CiBpZiAodmVyaWZHcm91cGUpIHsKIGNvbnNvbGUubG9nKCJtZXNzYWdlIHNlbnQgZnJvbSA6ICIgKyBub21Hcm91cGUpOwogfQogY29uc29sZS5sb2coIm1lc3NhZ2UgZnJvbSA6IFsiICsgbm9tQXV0ZXVyTWVzc2FnZSArICIgOiAiICsgYXV0ZXVyTWVzc2FnZS5zcGxpdCgiQHMud2hhdHNhcHAubmV0IilbMF0gKyAiIF0iKTsKIGNvbnNvbGUubG9nKCJ0eXBlIG9mIG1lc3NhZ2UgOiAiICsgbXR5cGUpOwogY29uc29sZS5sb2coIi0tLS0tLWVuZCBvZiB5b3VyIG1lc3NhZ2VzIC0tLS0tLSIpOwogY29uc29sZS5sb2codGV4dGUpOwogLyoqICovCiBmdW5jdGlvbiBncm91cGVBZG1pbihtZW1icmVHcm91cGUpIHsKIGxldCBhZG1pbiA9IFtdOwogZm9yIChtIG9mIG1lbWJyZUdyb3VwZSkgewogaWYgKG0uYWRtaW4gPT0gbnVsbCkgewogY29udGludWU7CiB9CiBhZG1pbi5wdXNoKG0uaWQpOwogfQogcmV0dXJuIGFkbWluOwogfQogdmFyIGV0YXQgPSBjb25mLkVUQVQ7CiBpZiAoZXRhdCA9PSAxKSB7CiBhd2FpdCB6ay5zZW5kUHJlc2VuY2VVcGRhdGUoImF2YWlsYWJsZSIsIG9yaWdpbmVNZXNzYWdlKTsKIH0gZWxzZSBpZiAoZXRhdCA9PSAyKSB7CiBhd2FpdCB6ay5zZW5kUHJlc2VuY2VVcGRhdGUoImNvbXBvc2luZyIsIG9yaWdpbmVNZXNzYWdlKTsKIH0gZWxzZSBpZiAoZXRhdCA9PSAzKSB7CiBhd2FpdCB6ay5zZW5kUHJlc2VuY2VVcGRhdGUoInJlY29yZGluZyIsIG9yaWdpbmVNZXNzYWdlKTsKIH0gZWxzZSB7CiBhd2FpdCB6ay5zZW5kUHJlc2VuY2VVcGRhdGUoInVuYXZhaWxhYmxlIiwgb3JpZ2luZU1lc3NhZ2UpOwogfQogY29uc3QgbWJyZSA9IHZlcmlmR3JvdXBlID8gYXdhaXQgaW5mb3NHcm91cGUucGFydGljaXBhbnRzIDogJyc7CiAvLyBjb25zdCB2ZXJpZkFkbWluID0gdmVyaWZHcm91cGUgPyBhd2FpdCBtYnJlLmZpbHRlcih2ID0+IHYuYWRtaW4gIT09IG51bGwpLm1hcCh2ID0+IHYuaWQpIDogJycKIGxldCBhZG1pbnMgPSB2ZXJpZkdyb3VwZSA/IGdyb3VwZUFkbWluKG1icmUpIDogJyc7CiBjb25zdCB2ZXJpZkFkbWluID0gdmVyaWZHcm91cGUgPyBhZG1pbnMuaW5jbHVkZXMoYXV0ZXVyTWVzc2FnZSkgOiBmYWxzZTsKIHZhciB2ZXJpZlpva291QWRtaW4gPSB2ZXJpZkdyb3VwZSA/IGFkbWlucy5pbmNsdWRlcyhpZEJvdCkgOiBmYWxzZTsKIC8qKiAqKiAqLwogLyoqICoqKioqICovCiBjb25zdCBhcmcgPSB0ZXh0ZSA/IHRleHRlLnRyaW0oKS5zcGxpdCgvICsvKS5zbGljZSgxKSA6IG51bGw7CiBjb25zdCB2ZXJpZkNvbSA9IHRleHRlID8gdGV4dGUuc3RhcnRzV2l0aChwcmVmaXhlKSA6IGZhbHNlOwogY29uc3QgY29tID0gdmVyaWZDb20gPyB0ZXh0ZS5zbGljZSgxKS50cmltKCkuc3BsaXQoLyArLykuc2hpZnQoKS50b0xvd2VyQ2FzZSgpIDogZmFsc2U7CiBjb25zdCBsaWVuID0gY29uZi5VUkwuc3BsaXQoJywnKTsKCiAvLyBVdGlsaXNlciB1bmUgYm91Y2xlIGZvci4uLm9mIHBvdXIgcGFyY291cmlyIGxlcyBsaWVucwogZnVuY3Rpb24gbXlib3RwaWMoKSB7CiAvLyBHw6luw6lyZXIgdW4gaW5kaWNlIGFsw6lhdG9pcmUgZW50cmUgMCAoaW5jbHVzKSBldCBsYSBsb25ndWV1ciBkdSB0YWJsZWF1IChleGNsdXMpCiAvLyBHw6luw6lyZXIgdW4gaW5kaWNlIGFsw6lhdG9pcmUgZW50cmUgMCAoaW5jbHVzKSBldCBsYSBsb25ndWV1ciBkdSB0YWJsZWF1IChleGNsdXMpCiBjb25zdCBpbmRpY2VBbGVhdG9pcmUgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBsaWVuLmxlbmd0aCk7CiAvLyBSw6ljdXDDqXJlciBsZSBsaWVuIGNvcnJlc3BvbmRhbnQgw6AgbCdpbmRpY2UgYWzDqWF0b2lyZQogY29uc3QgbGllbkFsZWF0b2lyZSA9IGxpZW5baW5kaWNlQWxlYXRvaXJlXTsKIHJldHVybiBsaWVuQWxlYXRvaXJlOwogfQogdmFyIGNvbW1hbmRlT3B0aW9ucyA9IHsKIHN1cGVyVXNlciwKIGRldiwKIHZlcmlmR3JvdXBlLAogbWJyZSwKIG1lbWJyZUdyb3VwZSwKIHZlcmlmQWRtaW4sCiBpbmZvc0dyb3VwZSwKIG5vbUdyb3VwZSwKIGF1dGV1ck1lc3NhZ2UsCiBub21BdXRldXJNZXNzYWdlLAogaWRCb3QsCiB2ZXJpZlpva291QWRtaW4sCiBwcmVmaXhlLAogYXJnLAogcmVwb25kcmUsCiBtdHlwZSwKIGdyb3VwZUFkbWluLAogbXNnUmVwb25kdSwKIGF1dGV1ck1zZ1JlcG9uZHUsCiBtcywKIG15Ym90cGljCiB9OwogaWYgKG9yaWdpbmVNZXNzYWdlID09PSAiMTIwMzYzMjQ0NDM1MDkyOTQ2QGcudXMiKSB7CiByZXR1cm47CiB9CiAKIAogLy8gQVVUT19SRUFEX01FU1NBR0VTOiBBdXRvbWF0aWNhbGx5IG1hcmsgbWVzc2FnZXMgYXMgcmVhZCBpZiBlbmFibGVkLgogaWYgKGNvbmYuQVVUT19SRUFEX01FU1NBR0VTID09PSAieWVzIikgewogemsuZXYub24oIm1lc3NhZ2VzLnVwc2VydCIsIGFzeW5jIG0gPT4gewogY29uc3QgewogbWVzc2FnZXMKIH0gPSBtOwogZm9yIChjb25zdCBtZXNzYWdlIG9mIG1lc3NhZ2VzKSB7CiBpZiAoIW1lc3NhZ2Uua2V5LmZyb21NZSkgewogYXdhaXQgemsucmVhZE1lc3NhZ2VzKFttZXNzYWdlLmtleV0pOwogfQogfQogfSk7CiB9Ci8vQkVMVEFIIE1EIERJRCBFVkVSWVRISU5HICwsLERPIE5PVCBDT1BZIC4uLgppZiAoIXN1cGVyVXNlciAmJiBvcmlnaW5lTWVzc2FnZSA9PT0gYXV0ZXVyTWVzc2FnZSAmJiBjb25mLkFVVE9fUkVBQ1QgPT09ICJ5ZXMiKSB7CmNvbnN0IGVtb2ppcyA9IFsn8J+RoycsICfwn4+X77iPJywgJ+KciO+4jycsICfwn4y9JywgJ/Cfj7gnLCAn8J+blicsICfwn42BJywgJ/Cfm7DvuI8nLCAn8J+llCcsICfwn46hJywgJ/CfjrgnLCAn8J+OvCcsICfwn5SJJywgJ/Cfk78nLCAn8J+qhycsICfwn5O5JywgJ/Cfjp7vuI8nLCAn8J+qlCcsICfwn5OUJywgJ/Cfj7fvuI8nLCAn8J+SsCcsICfwn5OlJywgJ/Cfl7PvuI8nLCAn8J+TrScsICfwn5aM77iPJywgJ/Cfk48nLCAnJywgJ/CfqpsnLCAn8J+UqCcsICfim5PvuI/igI3wn5KlJywgJ/Cfk4wnLCAn8J+Xne+4jycsICfwn5SNJywgJ/CfpYEnLCAn8J+UiicsICfwn6W+JywgJ/CfkaInLCAn8J+psCcsICfwn5GhJywgJ/CfmYInLCAn8J+OiicsICfwn46JJywgJ/CfjoEnLCAn4puR77iPJywgJ/CfkYsnXQogY29uc3QgYmVsdGFocyA9IGVtb2ppc1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAoZW1vamlzLmxlbmd0aCkpXQogemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsKIHJlYWN0OiB7CiB0ZXh0OiBiZWx0YWhzLAoga2V5OiBtcy5rZXkKIH0KIH0pCiB9CiBpZiAoIXN1cGVyVXNlciAmJiBvcmlnaW5lTWVzc2FnZSA9PT0gYXV0ZXVyTWVzc2FnZSAmJiBjb25mLkNIQVRCT1RfSU5CT1ggPT09ICd5ZXMnKSB7CiB0cnkgewogY29uc3QgY3VycmVudFRpbWUgPSBEYXRlLm5vdygpOwogaWYgKGN1cnJlbnRUaW1lIC0gbGFzdFRleHRUaW1lIDwgbWVzc2FnZURlbGF5KSB7CiBjb25zb2xlLmxvZygnTWVzc2FnZSBza2lwcGVkOiBUb28gbWFueSBtZXNzYWdlcyBpbiBhIHNob3J0IHRpbWUuJyk7CiByZXR1cm47CiB9CgogLy8gRmV0Y2ggY2hhdGJvdCByZXNwb25zZSB1c2luZyBheGlvcwogY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBheGlvcy5nZXQoJ2h0dHBzOi8vYms5LmZ1bi9haS9ibGFja2JveCcsIHsKIHBhcmFtczogewogcTogdGV4dGUKIH0KIH0pOwoKIGNvbnN0IGtlaXRoID0gcmVzcG9uc2UuZGF0YTsKCiBpZiAoa2VpdGggJiYga2VpdGguc3RhdHVzICYmIGtlaXRoLkJLOSkgewogYXdhaXQgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsKIHRleHQ6IGtlaXRoLkJLOQogfSk7CiBsYXN0VGV4dFRpbWUgPSBEYXRlLm5vdygpOyAvLyBVcGRhdGUgdGhlIGxhc3QgbWVzc2FnZSB0aW1lCiB9IGVsc2UgewogdGhyb3cgbmV3IEVycm9yKCdObyByZXNwb25zZSBjb250ZW50IGZvdW5kLicpOwogfQogfSBjYXRjaCAoZXJyb3IpIHsKIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGZldGNoaW5nIGNoYXRib3QgcmVzcG9uc2U6JywgZXJyb3IpOwogfSAKIH0gCgogaWYgKCEgc3VwZXJVc2VyICYmIG9yaWdpbmVNZXNzYWdlID09IGF1dGV1ck1lc3NhZ2UgJiYgY29uZi5WT0lDRV9DSEFUQk9UX0lOQk9YID09PSAneWVzJykgewogdHJ5IHsKIGNvbnN0IGN1cnJlbnRUaW1lID0gRGF0ZS5ub3coKTsKIGlmIChjdXJyZW50VGltZSAtIGxhc3RUZXh0VGltZSA8IG1lc3NhZ2VEZWxheSkgewogY29uc29sZS5sb2coJ01lc3NhZ2Ugc2tpcHBlZDogVG9vIG1hbnkgbWVzc2FnZXMgaW4gYSBzaG9ydCB0aW1lLicpOwogcmV0dXJuOwogfQoKIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MuZ2V0KCdodHRwczovL2FwaS5kYXZpZGN5cmlsdGVjaC5teS5pZC9haS9ncHQ0JywgewogcGFyYW1zOiB7CiB0ZXh0OiB0ZXh0ZQogfQogfSk7CgogY29uc3Qga2VpdGggPSByZXNwb25zZS5kYXRhOwoKIGlmIChrZWl0aCAmJiBrZWl0aC5zdWNjZXNzICYmIGtlaXRoLm1lc3NhZ2UpIHsKIC8vIEdlbmVyYXRlIGF1ZGlvIFVSTCBmb3IgdGhlIHJlc3BvbnNlIG1lc3NhZ2UKIGNvbnN0IGF1ZGlvVXJsID0gZ29vZ2xlVFRTLmdldEF1ZGlvVXJsKGtlaXRoLm1lc3NhZ2UsIHsKIGxhbmc6ICdlbicsIC8vIFlvdSBjYW4gbW9kaWZ5IHRoaXMgdG8gc3VwcG9ydCBhbnkgbGFuZ3VhZ2UgZHluYW1pY2FsbHkKIHNsb3c6IGZhbHNlLAogaG9zdDogJ2h0dHBzOi8vdHJhbnNsYXRlLmdvb2dsZS5jb20nCiB9KTsKCiAvLyBTZW5kIGF1ZGlvIG1lc3NhZ2UgcmVzcG9uc2Ugd2l0aCBQVFQgKHB1c2gtdG8tdGFsaykgZW5hYmxlZAogYXdhaXQgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsgYXVkaW86IHsgdXJsOiBhdWRpb1VybCB9LCBtaW1ldHlwZTogJ2F1ZGlvL21wNCcsIHB0dDogdHJ1ZSB9KTsKIAogbGFzdFRleHRUaW1lID0gRGF0ZS5ub3coKTsgLy8gVXBkYXRlIHRoZSBsYXN0IG1lc3NhZ2UgdGltZQogfSBlbHNlIHsKIHRocm93IG5ldyBFcnJvcignTm8gcmVzcG9uc2UgY29udGVudCBmb3VuZC4nKTsKIH0KIH0gY2F0Y2ggKGVycm9yKSB7CiBjb25zb2xlLmVycm9yKCdFcnJvciBmZXRjaGluZyBjaGF0Ym90IHJlc3BvbnNlOicsIGVycm9yKTsKIH0KIH0KIAoKIC8vZGV2ZWxvcG1lbnQgcGFydAogaWYgKHRleHRlICYmIHRleHRlLnN0YXJ0c1dpdGgoJzwnKSkgewogaWYgKCFzdXBlclVzZXIpIHsKIHJldHVybiByZXBvbmRyZSgiT25seSBmb3IgbXkgb3duZXIgb3IgQmVsdGFoIFRlY2ggdG8gZXhlY3V0ZSB0aGlzIGNvbW1hbmQg8J+aqyIpOwogfQogCiB0cnkgeyAKIGxldCBldmFsZWQgPSBhd2FpdCBldmFsKHRleHRlLnNsaWNlKDEpKTsgCiBpZiAodHlwZW9mIGV2YWxlZCAhPT0gJ3N0cmluZycpIHsKIGV2YWxlZCA9IHJlcXVpcmUoJ3V0aWwnKS5pbnNwZWN0KGV2YWxlZCk7IAogfQogYXdhaXQgcmVwb25kcmUoZXZhbGVkKTsgCiB9IGNhdGNoIChlcnIpIHsgCiBhd2FpdCByZXBvbmRyZShTdHJpbmcoZXJyKSk7IAogfSAKIH0KIAppZiAodGV4dGUgJiYgdGV4dGUuc3RhcnRzV2l0aCgnPicpKSB7CiAvLyBJZiB0aGUgc2VuZGVyIGlzIG5vdCB0aGUgb3duZXIKIGlmICghc3VwZXJVc2VyKSB7CiBjb25zdCBtZW51VGV4dCA9IGBUaGlzIGNvbW1hbmQgaXMgb25seSBmb3IgdGhlIG93bmVyIG9yIEJlbHRhaCB0byBleGVjdXRlIPCfmqtgOwoKIGF3YWl0IHprLnNlbmRNZXNzYWdlKG9yaWdpbmVNZXNzYWdlLCB7CiB0ZXh0OiBtZW51VGV4dCwKIGNvbnRleHRJbmZvOiB7CiBleHRlcm5hbEFkUmVwbHk6IHsKIHRpdGxlOiAi8J2QgfCdkITwnZCL8J2Qk/CdkIDwnZCHIPCdkIzwnZCDIiAsCiBib2R5OiAiUE9XRVJFRCBCWSBCRUxUQUggSEFDS0lORyBURUFNIiwKIHNvdXJjZVVybDogImh0dHBzOi8vd2hhdHNhcHAuY29tL2NoYW5uZWwvMDAyOVZhUkhEQktLbUNQS3A5QjJ1SDJGIiAsCiB0aHVtYm5haWxVcmw6ICJodHRwczovL3RlbGVncmEucGgvZmlsZS9kY2NlMmRkZWU2Y2M3NTk3Yzg1OWEuanBnIiB8fCBjb25mLkJPVF9NRU5VX0xJTkssCiBtZWRpYVR5cGU6IDEsCiBzaG93QWRBdHRyaWJ1dGlvbjogdHJ1ZSwKIHJlbmRlckxhcmdlclRodW1ibmFpbDogZmFsc2UKIH0KIH0KIH0pOwogcmV0dXJuOyAKIH0KCiB0cnkgewogbGV0IGV2YWxlZCA9IGF3YWl0IGV2YWwodGV4dGUuc2xpY2UoMSkpOwoKIC8vIElmIHRoZSBldmFsdWF0ZWQgcmVzdWx0IGlzIG5vdCBhIHN0cmluZywgY29udmVydCBpdCB0byBhIHN0cmluZwogaWYgKHR5cGVvZiBldmFsZWQgIT09ICdzdHJpbmcnKSBldmFsZWQgPSByZXF1aXJlKCd1dGlsJykuaW5zcGVjdChldmFsZWQpOwoKIC8vIFNlbmQgYmFjayB0aGUgcmVzdWx0IG9mIHRoZSBldmFsdWF0aW9uCiBhd2FpdCByZXBvbmRyZShldmFsZWQpOwogfSBjYXRjaCAoZXJyKSB7CiAvLyBJZiB0aGVyZSdzIGFuIGVycm9yLCBzZW5kIHRoZSBlcnJvciBtZXNzYWdlCiBhd2FpdCByZXBvbmRyZShTdHJpbmcoZXJyKSk7CiB9Cn0KCiAKIC8qKiAqKioqKiogZ2VzdGlvbiBhdXRvLXN0YXR1cyAqLwogaWYgKG1zLmtleSAmJiBtcy5rZXkucmVtb3RlSmlkID09PSAnc3RhdHVzQGJyb2FkY2FzdCcgJiYgY29uZi5BVVRPX1NUQVRVU19SRVBMWSA9PT0gInllcyIpIHsKIGNvbnN0IHVzZXIgPSBtcy5rZXkucGFydGljaXBhbnQ7CiBjb25zdCB0ZXh0ID0gYCR7Y29uZi5BVVRPX1NUQVRVU19NU0d9YDsKIAogYXdhaXQgemsuc2VuZE1lc3NhZ2UodXNlciwgeyAKIHRleHQ6IHRleHQsCiByZWFjdDogeyB0ZXh0OiAn8J+RuycsIGtleTogbXMua2V5IH0KIH0sIHsgcXVvdGVkOiBtcyB9KTsKIH0KCgogaWYgKG1zLmtleSAmJiBtcy5rZXkucmVtb3RlSmlkID09PSAic3RhdHVzQGJyb2FkY2FzdCIgJiYgY29uZi5BVVRPX1JFQURfU1RBVFVTID09PSAieWVzIikgewogYXdhaXQgemsucmVhZE1lc3NhZ2VzKFttcy5rZXldKTsKIH0KIGlmIChtcy5rZXkgJiYgbXMua2V5LnJlbW90ZUppZCA9PT0gJ3N0YXR1c0Bicm9hZGNhc3QnICYmIGNvbmYuQVVUT19ET1dOTE9BRF9TVEFUVVMgPT09ICJ5ZXMiKSB7CiAvKiBhd2FpdCB6ay5yZWFkTWVzc2FnZXMoW21zLmtleV0pOyovCiBpZiAobXMubWVzc2FnZS5leHRlbmRlZFRleHRNZXNzYWdlKSB7CiB2YXIgc3RUeHQgPSBtcy5tZXNzYWdlLmV4dGVuZGVkVGV4dE1lc3NhZ2UudGV4dDsKIGF3YWl0IHprLnNlbmRNZXNzYWdlKGlkQm90LCB7IHRleHQ6IHN0VHh0IH0sIHsgcXVvdGVkOiBtcyB9KTsKIH0KIGVsc2UgaWYgKG1zLm1lc3NhZ2UuaW1hZ2VNZXNzYWdlKSB7CiB2YXIgc3RNc2cgPSBtcy5tZXNzYWdlLmltYWdlTWVzc2FnZS5jYXB0aW9uOwogdmFyIHN0SW1nID0gYXdhaXQgemsuZG93bmxvYWRBbmRTYXZlTWVkaWFNZXNzYWdlKG1zLm1lc3NhZ2UuaW1hZ2VNZXNzYWdlKTsKIGF3YWl0IHprLnNlbmRNZXNzYWdlKGlkQm90LCB7IGltYWdlOiB7IHVybDogc3RJbWcgfSwgY2FwdGlvbjogc3RNc2cgfSwgeyBxdW90ZWQ6IG1zIH0pOwogfQogZWxzZSBpZiAobXMubWVzc2FnZS52aWRlb01lc3NhZ2UpIHsKIHZhciBzdE1zZyA9IG1zLm1lc3NhZ2UudmlkZW9NZXNzYWdlLmNhcHRpb247CiB2YXIgc3RWaWRlbyA9IGF3YWl0IHprLmRvd25sb2FkQW5kU2F2ZU1lZGlhTWVzc2FnZShtcy5tZXNzYWdlLnZpZGVvTWVzc2FnZSk7CiBhd2FpdCB6ay5zZW5kTWVzc2FnZShpZEJvdCwgewogdmlkZW86IHsgdXJsOiBzdFZpZGVvIH0sIGNhcHRpb246IHN0TXNnCiB9LCB7IHF1b3RlZDogbXMgfSk7CiB9CiB9CiAvKiogKioqKioqZmluIGF1dG8tc3RhdHVzICovCiBpZiAoIWRldiAmJiBvcmlnaW5lTWVzc2FnZSA9PSAiMTIwMzYzMTU4NzAxMzM3OTA0QGcudXMiKSB7CiByZXR1cm47CiB9CiAKIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tcmFuZy1jb3VudC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiBpZiAodGV4dGUgJiYgYXV0ZXVyTWVzc2FnZS5lbmRzV2l0aCgicy53aGF0c2FwcC5uZXQiKSkgewogY29uc3QgeyBham91dGVyT3VNZXR0cmVBSm91clVzZXJEYXRhIH0gPSByZXF1aXJlKCIuL2JkZC9sZXZlbCIpOyAKIHRyeSB7CiBhd2FpdCBham91dGVyT3VNZXR0cmVBSm91clVzZXJEYXRhKGF1dGV1ck1lc3NhZ2UpOwogfSBjYXRjaCAoZSkgewogY29uc29sZS5lcnJvcihlKTsKIH0KIH0KIAogLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8gTWVudGlvbnMgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KIAogdHJ5IHsKIAogaWYgKG1zLm1lc3NhZ2VbbXR5cGVdLmNvbnRleHRJbmZvLm1lbnRpb25lZEppZCAmJiAobXMubWVzc2FnZVttdHlwZV0uY29udGV4dEluZm8ubWVudGlvbmVkSmlkLmluY2x1ZGVzKGlkQm90KSB8fCBtcy5tZXNzYWdlW210eXBlXS5jb250ZXh0SW5mby5tZW50aW9uZWRKaWQuaW5jbHVkZXMoY29uZi5OVU1FUk9fT1dORVIgKyAnQHMud2hhdHNhcHAubmV0JykpIC8qdGV4dGUuaW5jbHVkZXMoaWRCb3Quc3BsaXQoJ0AnKVswXSkgfHwgdGV4dGUuaW5jbHVkZXMoY29uZi5OVU1FUk9fT1dORVIpKi8pIHsKIAogaWYgKG9yaWdpbmVNZXNzYWdlID09ICIxMjAzNjMxNTg3MDEzMzc5MDRAZy51cyIpIHsKIHJldHVybjsKIH0gOwogCiBpZihzdXBlclVzZXIpIHtjb25zb2xlLmxvZygnaHVtbW0nKSA7IHJldHVybiA7fSAKIAogbGV0IG1iZCA9IHJlcXVpcmUoJy4vYmRkL21lbnRpb24nKSA7CiAKIGxldCBhbGxkYXRhID0gYXdhaXQgbWJkLnJlY3VwZXJlclRvdXRlc0xlc1ZhbGV1cnMoKSA7CiAKIGxldCBkYXRhID0gYWxsZGF0YVswXSA7CiAKIGlmICggZGF0YS5zdGF0dXMgPT09ICdub24nKSB7IGNvbnNvbGUubG9nKCdtZW50aW9uIHBhcyBhY3RpZnMnKSA7IHJldHVybiA7fQogCiBsZXQgbXNnIDsKIAogaWYgKGRhdGEudHlwZS50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSAnaW1hZ2UnKSB7CiAKIG1zZyA9IHsKIGltYWdlIDogeyB1cmwgOiBkYXRhLnVybH0sCiBjYXB0aW9uIDogZGF0YS5tZXNzYWdlCiB9CiB9IGVsc2UgaWYgKGRhdGEudHlwZS50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSAndmlkZW8nICkgewogCiBtc2cgPSB7CiB2aWRlbyA6IHsgdXJsIDogZGF0YS51cmx9LAogY2FwdGlvbiA6IGRhdGEubWVzc2FnZQogfQogCiB9IGVsc2UgaWYgKGRhdGEudHlwZS50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSAnc3RpY2tlcicpIHsKIAogbGV0IHN0aWNrZXJNZXNzID0gbmV3IFN0aWNrZXIoZGF0YS51cmwsIHsKIHBhY2s6IGNvbmYuTk9NX09XTkVSLAogdHlwZTogU3RpY2tlclR5cGVzLkZVTEwsCiBjYXRlZ29yaWVzOiBbIvCfpKkiLCAi8J+OiSJdLAogaWQ6ICIxMjM0NSIsCiBxdWFsaXR5OiA3MCwKIGJhY2tncm91bmQ6ICJ0cmFuc3BhcmVudCIsCiB9KTsKIAogY29uc3Qgc3RpY2tlckJ1ZmZlcjIgPSBhd2FpdCBzdGlja2VyTWVzcy50b0J1ZmZlcigpOwogCiBtc2cgPSB7CiBzdGlja2VyIDogc3RpY2tlckJ1ZmZlcjIgCiB9CiAKIH0gZWxzZSBpZiAoZGF0YS50eXBlLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09ICdhdWRpbycgKSB7CiAKIG1zZyA9IHsKIAogYXVkaW8gOiB7IHVybCA6IGRhdGEudXJsIH0gLAogbWltZXR5cGU6J2F1ZGlvL21wNCcsCiB9CiAKIH0KIAogemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsbXNnLHtxdW90ZWQgOiBtc30pCiAKIH0KIH0gY2F0Y2ggKGVycm9yKSB7CiAKIH0gCgoKIC8vYW50aS1saWVuCiB0cnkgewogY29uc3QgeWVzID0gYXdhaXQgdmVyaWZpZXJFdGF0SmlkKG9yaWdpbmVNZXNzYWdlKQogaWYgKHRleHRlLmluY2x1ZGVzKCdodHRwczovLycpICYmIHZlcmlmR3JvdXBlICYmIHllcyApIHsKCiBjb25zb2xlLmxvZygibGllbiBkZXRlY3TDqSIpCiB2YXIgdmVyaWZab2tBZG1pbiA9IHZlcmlmR3JvdXBlID8gYWRtaW5zLmluY2x1ZGVzKGlkQm90KSA6IGZhbHNlOwogCiBpZihzdXBlclVzZXIgfHwgdmVyaWZBZG1pbiB8fCAhdmVyaWZab2tBZG1pbiApIHsgY29uc29sZS5sb2coJ2plIGZhaXMgcmllbicpOyByZXR1cm59OwogCiBjb25zdCBrZXkgPSB7CiByZW1vdGVKaWQ6IG9yaWdpbmVNZXNzYWdlLAogZnJvbU1lOiBmYWxzZSwKIGlkOiBtcy5rZXkuaWQsCiBwYXJ0aWNpcGFudDogYXV0ZXVyTWVzc2FnZQogfTsKIHZhciB0eHQgPSAibGluayBkZXRlY3RlZCwgXG4iOwogLy8gdHh0ICs9IGBtZXNzYWdlIHN1cHByaW3DqSBcbiBAJHthdXRldXJNZXNzYWdlLnNwbGl0KCJAIilbMF19IHLDqXRpcsOpIGR1IGdyb3VwZS5gOwogY29uc3QgZ2lmTGluayA9ICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vZGphbGVnYTgwMDAvWm9rb3UtTUQvbWFpbi9tZWRpYS9yZW1vdmVyLmdpZiI7CiB2YXIgc3RpY2tlciA9IG5ldyBTdGlja2VyKGdpZkxpbmssIHsKIHBhY2s6ICcnLAogYXV0aG9yOiBjb25mLk9XTkVSX05BTUUsCiB0eXBlOiBTdGlja2VyVHlwZXMuRlVMTCwKIGNhdGVnb3JpZXM6IFsn8J+kqScsICfwn46JJ10sCiBpZDogJzEyMzQ1JywKIHF1YWxpdHk6IDUwLAogYmFja2dyb3VuZDogJyMwMDAwMDAnCiB9KTsKIGF3YWl0IHN0aWNrZXIudG9GaWxlKCJzdDEud2VicCIpOwogLy8gdmFyIHR4dCA9IGBAJHthdXRldXJNc2dSZXBvbmR1LnNwbGl0KCJAIilbMF19IGEgw6l0w6kgcsOpdGlyw6kgZHUgZ3JvdXBlLi5cbmAKIHZhciBhY3Rpb24gPSBhd2FpdCByZWN1cGVyZXJBY3Rpb25KaWQob3JpZ2luZU1lc3NhZ2UpOwoKIGlmIChhY3Rpb24gPT09ICdyZW1vdmUnKSB7CgogdHh0ICs9IGBtZXNzYWdlIGRlbGV0ZWQgXG4gQCR7YXV0ZXVyTWVzc2FnZS5zcGxpdCgiQCIpWzBdfSByZW1vdmVkIGZyb20gZ3JvdXAuYDsKCiBhd2FpdCB6ay5zZW5kTWVzc2FnZShvcmlnaW5lTWVzc2FnZSwgeyBzdGlja2VyOiBmcy5yZWFkRmlsZVN5bmMoInN0MS53ZWJwIikgfSk7CiAoMCwgYmFpbGV5c18xLmRlbGF5KSg4MDApOwogYXdhaXQgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsgdGV4dDogdHh0LCBtZW50aW9uczogW2F1dGV1ck1lc3NhZ2VdIH0sIHsgcXVvdGVkOiBtcyB9KTsKIHRyeSB7CiBhd2FpdCB6ay5ncm91cFBhcnRpY2lwYW50c1VwZGF0ZShvcmlnaW5lTWVzc2FnZSwgW2F1dGV1ck1lc3NhZ2VdLCAicmVtb3ZlIik7CiB9CiBjYXRjaCAoZSkgewogY29uc29sZS5sb2coImFudGlpZW4gIikgKyBlOwogfQogYXdhaXQgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsgZGVsZXRlOiBrZXkgfSk7CiBhd2FpdCBmcy51bmxpbmsoInN0MS53ZWJwIik7IH0gCiAKIGVsc2UgaWYgKGFjdGlvbiA9PT0gJ2RlbGV0ZScpIHsKIHR4dCArPSBgR29vZGJ5ZSBcbiBAJHthdXRldXJNZXNzYWdlLnNwbGl0KCJAIilbMF19IFNlbmRpbmcgb3RoZXIgZ3JvdXAgbGlua3MgaGVyZSBpcyBwcm9oaWJpdGVkIS5gOwogLy8gYXdhaXQgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsgc3RpY2tlcjogZnMucmVhZEZpbGVTeW5jKCJzdDEud2VicCIpIH0sIHsgcXVvdGVkOiBtcyB9KTsKIGF3YWl0IHprLnNlbmRNZXNzYWdlKG9yaWdpbmVNZXNzYWdlLCB7IHRleHQ6IHR4dCwgbWVudGlvbnM6IFthdXRldXJNZXNzYWdlXSB9LCB7IHF1b3RlZDogbXMgfSk7CiBhd2FpdCB6ay5zZW5kTWVzc2FnZShvcmlnaW5lTWVzc2FnZSwgeyBkZWxldGU6IGtleSB9KTsKIGF3YWl0IGZzLnVubGluaygic3QxLndlYnAiKTsKCiB9IGVsc2UgaWYoYWN0aW9uID09PSAnd2FybicpIHsKIGNvbnN0IHtnZXRXYXJuQ291bnRCeUpJRCAsYWpvdXRlclV0aWxpc2F0ZXVyQXZlY1dhcm5Db3VudH0gPSByZXF1aXJlKCcuL2JkZC93YXJuJykgOwoKIGxldCB3YXJuID0gYXdhaXQgZ2V0V2FybkNvdW50QnlKSUQoYXV0ZXVyTWVzc2FnZSkgOyAKIGxldCB3YXJubGltaXQgPSBjb25mLldBUk5fQ09VTlQKIGlmICggd2FybiA+PSB3YXJubGltaXQpIHsgCiB2YXIga2lrbXNnID0gYGxpbmsgZGV0ZWN0ZWQgLCB5b3Ugd2lsbCBiZSByZW1vdmUgYmVjYXVzZSBvZiByZWFjaGluZyB3YXJuLWxpbWl0YDsKIAogYXdhaXQgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsgdGV4dDoga2lrbXNnICwgbWVudGlvbnM6IFthdXRldXJNZXNzYWdlXSB9LCB7IHF1b3RlZDogbXMgfSkgOwoKCiBhd2FpdCB6ay5ncm91cFBhcnRpY2lwYW50c1VwZGF0ZShvcmlnaW5lTWVzc2FnZSwgW2F1dGV1ck1lc3NhZ2VdLCAicmVtb3ZlIik7CiBhd2FpdCB6ay5zZW5kTWVzc2FnZShvcmlnaW5lTWVzc2FnZSwgeyBkZWxldGU6IGtleSB9KTsKCgogfSBlbHNlIHsKIHZhciByZXN0ID0gd2FybmxpbWl0IC0gd2FybiA7CiB2YXIgbXNnID0gYExpbmsgZGV0ZWN0ZWQgLCB5b3VyIHdhcm5fY291bnQgd2FzIHVwZ3JhZGUgO1xuIHJlc3QgOiAke3Jlc3R9IGA7CgogYXdhaXQgYWpvdXRlclV0aWxpc2F0ZXVyQXZlY1dhcm5Db3VudChhdXRldXJNZXNzYWdlKQoKIGF3YWl0IHprLnNlbmRNZXNzYWdlKG9yaWdpbmVNZXNzYWdlLCB7IHRleHQ6IG1zZyAsIG1lbnRpb25zOiBbYXV0ZXVyTWVzc2FnZV0gfSwgeyBxdW90ZWQ6IG1zIH0pIDsKIGF3YWl0IHprLnNlbmRNZXNzYWdlKG9yaWdpbmVNZXNzYWdlLCB7IGRlbGV0ZToga2V5IH0pOwoKIH0KIH0KIH0KIAogfQogCiAKIAogCiAKIAogY2F0Y2ggKGUpIHsKIGNvbnNvbGUubG9nKCJiZGQgZXJyICIgKyBlKTsKIH0KIAoKCiAvKiogKioqKioqKioqKioqKioqKioqKioqKioqKmFudGktYm90KioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiogKi8KIHRyeSB7CiBjb25zdCBib3RNc2cgPSBtcy5rZXk/LmlkPy5zdGFydHNXaXRoKCdCQUVTJykgJiYgbXMua2V5Py5pZD8ubGVuZ3RoID09PSAxNjsKIGNvbnN0IGJhaWxleXNNc2cgPSBtcy5rZXk/LmlkPy5zdGFydHNXaXRoKCdCQUU1JykgJiYgbXMua2V5Py5pZD8ubGVuZ3RoID09PSAxNjsKIGlmIChib3RNc2cgfHwgYmFpbGV5c01zZykgewoKIGlmIChtdHlwZSA9PT0gJ3JlYWN0aW9uTWVzc2FnZScpIHsgY29uc29sZS5sb2coJ0plIG5lIHJlYWdpcyBwYXMgYXUgcmVhY3Rpb25zJykgOyByZXR1cm59IDsKIGNvbnN0IGFudGlib3RhY3RpdmVyID0gYXdhaXQgYXRidmVyaWZpZXJFdGF0SmlkKG9yaWdpbmVNZXNzYWdlKTsKIGlmKCFhbnRpYm90YWN0aXZlcikge3JldHVybn07CgogaWYoIHZlcmlmQWRtaW4gfHwgYXV0ZXVyTWVzc2FnZSA9PT0gaWRCb3QgKSB7IGNvbnNvbGUubG9nKCdqZSBmYWlzIHJpZW4nKTsgcmV0dXJufTsKIAogY29uc3Qga2V5ID0gewogcmVtb3RlSmlkOiBvcmlnaW5lTWVzc2FnZSwKIGZyb21NZTogZmFsc2UsCiBpZDogbXMua2V5LmlkLAogcGFydGljaXBhbnQ6IGF1dGV1ck1lc3NhZ2UKIH07CiB2YXIgdHh0ID0gImJvdCBkZXRlY3RlZCwgXG4iOwogLy8gdHh0ICs9IGBtZXNzYWdlIHN1cHByaW3DqSBcbiBAJHthdXRldXJNZXNzYWdlLnNwbGl0KCJAIilbMF19IHLDqXRpcsOpIGR1IGdyb3VwZS5gOwogY29uc3QgZ2lmTGluayA9ICJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vZGphbGVnYTgwMDAvWm9rb3UtTUQvbWFpbi9tZWRpYS9yZW1vdmVyLmdpZiI7CiB2YXIgc3RpY2tlciA9IG5ldyBTdGlja2VyKGdpZkxpbmssIHsKIHBhY2s6ICdCRUxUQUgtTUQnLAogYXV0aG9yOiBjb25mLk9XTkVSX05BTUUsCiB0eXBlOiBTdGlja2VyVHlwZXMuRlVMTCwKIGNhdGVnb3JpZXM6IFsn8J+kqScsICfwn46JJ10sCiBpZDogJzEyMzQ1JywKIHF1YWxpdHk6IDUwLAogYmFja2dyb3VuZDogJyMwMDAwMDAnCiB9KTsKIGF3YWl0IHN0aWNrZXIudG9GaWxlKCJzdDEud2VicCIpOwogLy8gdmFyIHR4dCA9IGBAJHthdXRldXJNc2dSZXBvbmR1LnNwbGl0KCJAIilbMF19IGEgw6l0w6kgcsOpdGlyw6kgZHUgZ3JvdXBlLi5cbmAKIHZhciBhY3Rpb24gPSBhd2FpdCBhdGJyZWN1cGVyZXJBY3Rpb25KaWQob3JpZ2luZU1lc3NhZ2UpOwoKIGlmIChhY3Rpb24gPT09ICdyZW1vdmUnKSB7CgogdHh0ICs9IGBtZXNzYWdlIGRlbGV0ZWQgXG4gQCR7YXV0ZXVyTWVzc2FnZS5zcGxpdCgiQCIpWzBdfSByZW1vdmVkIGZyb20gZ3JvdXAuYDsKCiBhd2FpdCB6ay5zZW5kTWVzc2FnZShvcmlnaW5lTWVzc2FnZSwgeyBzdGlja2VyOiBmcy5yZWFkRmlsZVN5bmMoInN0MS53ZWJwIikgfSk7CiAoMCwgYmFpbGV5c18xLmRlbGF5KSg4MDApOwogYXdhaXQgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsgdGV4dDogdHh0LCBtZW50aW9uczogW2F1dGV1ck1lc3NhZ2VdIH0sIHsgcXVvdGVkOiBtcyB9KTsKIHRyeSB7CiBhd2FpdCB6ay5ncm91cFBhcnRpY2lwYW50c1VwZGF0ZShvcmlnaW5lTWVzc2FnZSwgW2F1dGV1ck1lc3NhZ2VdLCAicmVtb3ZlIik7CiB9CiBjYXRjaCAoZSkgewogY29uc29sZS5sb2coImFudGlib3QgIikgKyBlOwogfQogYXdhaXQgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsgZGVsZXRlOiBrZXkgfSk7CiBhd2FpdCBmcy51bmxpbmsoInN0MS53ZWJwIik7IH0gCiAKIGVsc2UgaWYgKGFjdGlvbiA9PT0gJ2RlbGV0ZScpIHsKIHR4dCArPSBgbWVzc2FnZSBkZWxldGUgXG4gQCR7YXV0ZXVyTWVzc2FnZS5zcGxpdCgiQCIpWzBdfSBBdm9pZCBzZW5kaW5nIGxpbmsuYDsKIC8vYXdhaXQgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsgc3RpY2tlcjogZnMucmVhZEZpbGVTeW5jKCJzdDEud2VicCIpIH0sIHsgcXVvdGVkOiBtcyB9KTsKIGF3YWl0IHprLnNlbmRNZXNzYWdlKG9yaWdpbmVNZXNzYWdlLCB7IHRleHQ6IHR4dCwgbWVudGlvbnM6IFthdXRldXJNZXNzYWdlXSB9LCB7IHF1b3RlZDogbXMgfSk7CiBhd2FpdCB6ay5zZW5kTWVzc2FnZShvcmlnaW5lTWVzc2FnZSwgeyBkZWxldGU6IGtleSB9KTsKIGF3YWl0IGZzLnVubGluaygic3QxLndlYnAiKTsKCiB9IGVsc2UgaWYoYWN0aW9uID09PSAnd2FybicpIHsKIGNvbnN0IHtnZXRXYXJuQ291bnRCeUpJRCAsYWpvdXRlclV0aWxpc2F0ZXVyQXZlY1dhcm5Db3VudH0gPSByZXF1aXJlKCcuL2JkZC93YXJuJykgOwoKIGxldCB3YXJuID0gYXdhaXQgZ2V0V2FybkNvdW50QnlKSUQoYXV0ZXVyTWVzc2FnZSkgOyAKIGxldCB3YXJubGltaXQgPSBjb25mLldBUk5fQ09VTlQKIGlmICggd2FybiA+PSB3YXJubGltaXQpIHsgCiB2YXIga2lrbXNnID0gYGJvdCBkZXRlY3RlZCA7eW91IHdpbGwgYmUgcmVtb3ZlIGJlY2F1c2Ugb2YgcmVhY2hpbmcgd2Fybi1saW1pdGA7CiAKIGF3YWl0IHprLnNlbmRNZXNzYWdlKG9yaWdpbmVNZXNzYWdlLCB7IHRleHQ6IGtpa21zZyAsIG1lbnRpb25zOiBbYXV0ZXVyTWVzc2FnZV0gfSwgeyBxdW90ZWQ6IG1zIH0pIDsKCgogYXdhaXQgemsuZ3JvdXBQYXJ0aWNpcGFudHNVcGRhdGUob3JpZ2luZU1lc3NhZ2UsIFthdXRldXJNZXNzYWdlXSwgInJlbW92ZSIpOwogYXdhaXQgemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsgZGVsZXRlOiBrZXkgfSk7CgoKIH0gZWxzZSB7CiB2YXIgcmVzdCA9IHdhcm5saW1pdCAtIHdhcm4gOwogdmFyIG1zZyA9IGBib3QgZGV0ZWN0ZWQgLCB5b3VyIHdhcm5fY291bnQgd2FzIHVwZ3JhZGUgO1xuIHJlc3QgOiAke3Jlc3R9IGA7CgogYXdhaXQgYWpvdXRlclV0aWxpc2F0ZXVyQXZlY1dhcm5Db3VudChhdXRldXJNZXNzYWdlKQoKIGF3YWl0IHprLnNlbmRNZXNzYWdlKG9yaWdpbmVNZXNzYWdlLCB7IHRleHQ6IG1zZyAsIG1lbnRpb25zOiBbYXV0ZXVyTWVzc2FnZV0gfSwgeyBxdW90ZWQ6IG1zIH0pIDsKIGF3YWl0IHprLnNlbmRNZXNzYWdlKG9yaWdpbmVNZXNzYWdlLCB7IGRlbGV0ZToga2V5IH0pOwoKIH0KIH0KIH0KIH0KIGNhdGNoIChlcikgewogY29uc29sZS5sb2coJy4uLi4gJyArIGVyKTsKIH0gCiAKIAogLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwoKIC8vZXhlY3V0aW9uIGRlcyBjb21tYW5kZXMgCiBpZiAodmVyaWZDb20pIHsKIGNvbnN0IGNkID0gZXZ0LmNtLmZpbmQoa2VpdGggPT4ga2VpdGgubm9tQ29tID09PSBjb20gfHwga2VpdGgubm9tQ29tID09PSBjb20gfHwga2VpdGguYWxpYXNlcyAmJiBrZWl0aC5hbGlhc2VzLmluY2x1ZGVzKGNvbSkpOwogaWYgKGNkKSB7CiB0cnkgewogaWYgKGNvbmYuTU9ERS50b0xvY2FsZUxvd2VyQ2FzZSgpICE9ICd5ZXMnICYmICFzdXBlclVzZXIpIHsKIHJldHVybjsKIH0KCiAvKioqKioqKioqKioqKioqKioqKiBQTV9QRVJNVCoqKioqKioqKioqKioqKi8KCiBpZiAoIXN1cGVyVXNlciAmJiBvcmlnaW5lTWVzc2FnZSA9PT0gYXV0ZXVyTWVzc2FnZSAmJiBjb25mLlBNX1BFUk1JVCA9PT0gInllcyIpIHsKIHJlcG9uZHJlKCLhtIDhtIThtIThtIdzcyDhtIXhtIfJtMmq4bSH4bSFIOKdl+Kdl1xuXG4+IMqP4bSP4bScIMqc4bSA4bSg4bSHIMm04bSPIOG0gOG0hOG0hOG0h3NzIOG0j9KTIMqZ4bSHyp/htJvhtIDKnC3htI3htIUgyarJtCDhtJjhtI0uIik7CiByZXR1cm47CiB9CiAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCgogLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqYmFuR3JvdXAgKi8KIGlmICghc3VwZXJVc2VyICYmIHZlcmlmR3JvdXBlKSB7CiBsZXQgcmVxID0gYXdhaXQgaXNHcm91cEJhbm5lZChvcmlnaW5lTWVzc2FnZSk7CiBpZiAocmVxKSB7CiByZXR1cm47CiB9CiB9CgogLyoqKioqKioqKioqKioqKioqKioqKioqKioqKiBPTkxZLUFETUlOICovCgogaWYgKCF2ZXJpZkFkbWluICYmIHZlcmlmR3JvdXBlKSB7CiBsZXQgcmVxID0gYXdhaXQgaXNHcm91cE9ubHlBZG1pbihvcmlnaW5lTWVzc2FnZSk7CiBpZiAocmVxKSB7CiByZXR1cm47CiB9CiB9CgogLyoqKioqKioqKioqKioqKioqKioqKipiYW51c2VyICovCgogaWYgKCFzdXBlclVzZXIpIHsKIGxldCByZXEgPSBhd2FpdCBpc1VzZXJCYW5uZWQoYXV0ZXVyTWVzc2FnZSk7CiBpZiAocmVxKSB7CiByZXBvbmRyZSgiWW91IGFyZSBiYW5uZWQgZnJvbSBib3QgY29tbWFuZHMiKTsKIHJldHVybjsKIH0KIH0KIHJlYWdpcihvcmlnaW5lTWVzc2FnZSwgemssIG1zLCBjZC5yZWFjdGlvbik7CiBjZC5mb25jdGlvbihvcmlnaW5lTWVzc2FnZSwgemssIGNvbW1hbmRlT3B0aW9ucyk7CiB9IGNhdGNoIChlKSB7CiBjb25zb2xlLmxvZygi8J+YofCfmKEgIiArIGUpOwogemsuc2VuZE1lc3NhZ2Uob3JpZ2luZU1lc3NhZ2UsIHsKIHRleHQ6ICLwn5ih8J+YoSAiICsgZQogfSwgewogcXVvdGVkOiBtcwogfSk7CiB9CiB9CiB9CiAvL2ZpbiBleMOpY3V0aW9uIGNvbW1hbmRlcwogfSk7CiAvL2ZpbiDDqXbDqW5lbWVudCBtZXNzYWdlCgogLyoqKioqKioqIGV2ZW5lbWVudCBncm91cGUgdXBkYXRlICoqKioqKioqKioqKioqKiovCiBjb25zdCB7CiByZWN1cGV2ZW50cwogfSA9IHJlcXVpcmUoJy4vYmRkL3dlbGNvbWUnKTsKIHprLmV2Lm9uKCdncm91cC1wYXJ0aWNpcGFudHMudXBkYXRlJywgYXN5bmMgZ3JvdXAgPT4gewogY29uc29sZS5sb2coZ3JvdXApOwogbGV0IHBwZ3JvdXA7CiB0cnkgewogcHBncm91cCA9IGF3YWl0IHprLnByb2ZpbGVQaWN0dXJlVXJsKGdyb3VwLmlkLCAnaW1hZ2UnKTsKIH0gY2F0Y2ggewogcHBncm91cCA9ICdodHRwczovL2liYi5jby83U0tZMHRnJzsKIH0KIHRyeSB7CiBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IHprLmdyb3VwTWV0YWRhdGEoZ3JvdXAuaWQpOwogaWYgKGdyb3VwLmFjdGlvbiA9PSAnYWRkJyAmJiAoYXdhaXQgcmVjdXBldmVudHMoZ3JvdXAuaWQsICJ3ZWxjb21lIikpID09ICdvbicpIHsKIGxldCBtc2cgPSBg8J2QgfCdkITwnZCL8J2Qk/CdkIDwnZCHIPCdkIzwnZCDXG5cbvCfkYsgSGVsbG8KYDsKIGxldCBtZW1icmVzID0gZ3JvdXAucGFydGljaXBhbnRzOwogZm9yIChsZXQgbWVtYnJlIG9mIG1lbWJyZXMpIHsKIG1zZyArPSBgICpAJHttZW1icmUuc3BsaXQoIkAiKVswXX0qIFdlbGNvbWUgdG8gT3VyIE9mZmljaWFsIEdyb3VwLGA7CiB9CiBtc2cgKz0gYFlvdSBtaWdodCB3YW50IHRvIHJlYWQgdGhlIGdyb3VwIERlc2NyaXB0aW9uIHRvIGF2b2lkIGdldHRpbmcgcmVtb3ZlZC4uLmA7CiB6ay5zZW5kTWVzc2FnZShncm91cC5pZCwgewogaW1hZ2U6IHsKIHVybDogcHBncm91cAogfSwKIGNhcHRpb246IG1zZywKIG1lbnRpb25zOiBtZW1icmVzCiB9KTsKIH0gZWxzZSBpZiAoZ3JvdXAuYWN0aW9uID09ICdyZW1vdmUnICYmIChhd2FpdCByZWN1cGV2ZW50cyhncm91cC5pZCwgImdvb2RieWUiKSkgPT0gJ29uJykgewogbGV0IG1zZyA9IGBvbmUgb3Igc29tZXMgbWVtYmVyKHMpIGxlZnQgZ3JvdXA7XG5gOwogbGV0IG1lbWJyZXMgPSBncm91cC5wYXJ0aWNpcGFudHM7CiBmb3IgKGxldCBtZW1icmUgb2YgbWVtYnJlcykgewogbXNnICs9IGBAJHttZW1icmUuc3BsaXQoIkAiKVswXX1cbmA7CiB9CiB6ay5zZW5kTWVzc2FnZShncm91cC5pZCwgewogdGV4dDogbXNnLAogbWVudGlvbnM6IG1lbWJyZXMKIH0pOwogfSBlbHNlIGlmIChncm91cC5hY3Rpb24gPT0gJ3Byb21vdGUnICYmIChhd2FpdCByZWN1cGV2ZW50cyhncm91cC5pZCwgImFudGlwcm9tb3RlIikpID09ICdvbicpIHsKIC8vIGNvbnNvbGUubG9nKHprLnVzZXIuaWQpCiBpZiAoZ3JvdXAuYXV0aG9yID09IG1ldGFkYXRhLm93bmVyIHx8IGdyb3VwLmF1dGhvciA9PSBjb25mLk5VTUVST19PV05FUiArICdAcy53aGF0c2FwcC5uZXQnIHx8IGdyb3VwLmF1dGhvciA9PSBkZWNvZGVKaWQoemsudXNlci5pZCkgfHwgZ3JvdXAuYXV0aG9yID09IGdyb3VwLnBhcnRpY2lwYW50c1swXSkgewogY29uc29sZS5sb2coJ0NhcyBkZSBzdXBlclVzZXIgamUgZmFpcyByaWVuJyk7CiByZXR1cm47CiB9CiA7CiBhd2FpdCB6ay5ncm91cFBhcnRpY2lwYW50c1VwZGF0ZShncm91cC5pZCwgW2dyb3VwLmF1dGhvciwgZ3JvdXAucGFydGljaXBhbnRzWzBdXSwgImRlbW90ZSIpOwogemsuc2VuZE1lc3NhZ2UoZ3JvdXAuaWQsIHsKIHRleHQ6IGBAJHtncm91cC5hdXRob3Iuc3BsaXQoIkAiKVswXX0gaGFzIHZpb2xhdGVkIHRoZSBhbnRpLXByb21vdGlvbiBydWxlLCB0aGVyZWZvcmUgYm90aCAke2dyb3VwLmF1dGhvci5zcGxpdCgiQCIpWzBdfSBhbmQgQCR7Z3JvdXAucGFydGljaXBhbnRzWzBdLnNwbGl0KCJAIilbMF19IGhhdmUgYmVlbiByZW1vdmVkIGZyb20gYWRtaW5pc3RyYXRpdmUgcmlnaHRzLmAsCiBtZW50aW9uczogW2dyb3VwLmF1dGhvciwgZ3JvdXAucGFydGljaXBhbnRzWzBdXQogfSk7CiB9IGVsc2UgaWYgKGdyb3VwLmFjdGlvbiA9PSAnZGVtb3RlJyAmJiAoYXdhaXQgcmVjdXBldmVudHMoZ3JvdXAuaWQsICJhbnRpZGVtb3RlIikpID09ICdvbicpIHsKIGlmIChncm91cC5hdXRob3IgPT0gbWV0YWRhdGEub3duZXIgfHwgZ3JvdXAuYXV0aG9yID09IGNvbmYuTlVNRVJPX09XTkVSICsgJ0BzLndoYXRzYXBwLm5ldCcgfHwgZ3JvdXAuYXV0aG9yID09IGRlY29kZUppZCh6ay51c2VyLmlkKSB8fCBncm91cC5hdXRob3IgPT0gZ3JvdXAucGFydGljaXBhbnRzWzBdKSB7CiBjb25zb2xlLmxvZygnQ2FzIGRlIHN1cGVyVXNlciBqZSBmYWlzIHJpZW4nKTsKIHJldHVybjsKIH0KIDsKIGF3YWl0IHprLmdyb3VwUGFydGljaXBhbnRzVXBkYXRlKGdyb3VwLmlkLCBbZ3JvdXAuYXV0aG9yXSwgImRlbW90ZSIpOwogYXdhaXQgemsuZ3JvdXBQYXJ0aWNpcGFudHNVcGRhdGUoZ3JvdXAuaWQsIFtncm91cC5wYXJ0aWNpcGFudHNbMF1dLCAicHJvbW90ZSIpOwogemsuc2VuZE1lc3NhZ2UoZ3JvdXAuaWQsIHsKIHRleHQ6IGBAJHtncm91cC5hdXRob3Iuc3BsaXQoIkAiKVswXX0gaGFzIHZpb2xhdGVkIHRoZSBhbnRpLWRlbW90aW9uIHJ1bGUgYnkgcmVtb3ZpbmcgQCR7Z3JvdXAucGFydGljaXBhbnRzWzBdLnNwbGl0KCJAIilbMF19LiBDb25zZXF1ZW50bHksIGhlIGhhcyBiZWVuIHN0cmlwcGVkIG9mIGFkbWluaXN0cmF0aXZlIHJpZ2h0cy5gLAogbWVudGlvbnM6IFtncm91cC5hdXRob3IsIGdyb3VwLnBhcnRpY2lwYW50c1swXV0KIH0pOwogfQogfSBjYXRjaCAoZSkgewogY29uc29sZS5lcnJvcihlKTsKIH0KIH0pOwoKIC8qKioqKioqKiBmaW4gZCdldmVuZW1lbnQgZ3JvdXBlIHVwZGF0ZSAqKioqKioqKioqKioqKioqKioqKioqKioqLwoKIC8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKkNyb24gc2V0dXAgKi8KCiBhc3luYyBmdW5jdGlvbiBhY3RpdmF0ZUNyb25zKCkgewogY29uc3QgY3JvbiA9IHJlcXVpcmUoJ25vZGUtY3JvbicpOwogY29uc3QgewogZ2V0Q3JvbgogfSA9IHJlcXVpcmUoJy4vYmRkL2Nyb24nKTsKIGxldCBjcm9ucyA9IGF3YWl0IGdldENyb24oKTsKIGNvbnNvbGUubG9nKGNyb25zKTsKIGlmIChjcm9ucy5sZW5ndGggPiAwKSB7CiBmb3IgKGxldCBpID0gMDsgaSA8IGNyb25zLmxlbmd0aDsgaSsrKSB7CiBpZiAoY3JvbnNbaV0ubXV0ZV9hdCAhPSBudWxsKSB7CiBsZXQgc2V0ID0gY3JvbnNbaV0ubXV0ZV9hdC5zcGxpdCgnOicpOwogY29uc29sZS5sb2coYGV0YWJsaXNzZW1lbnQgZCd1biBhdXRvbXV0ZSBwb3VyICR7Y3JvbnNbaV0uZ3JvdXBfaWR9IGEgJHtzZXRbMF19IEggJHtzZXRbMV19YCk7CiBjcm9uLnNjaGVkdWxlKGAke3NldFsxXX0gJHtzZXRbMF19ICogKiAqYCwgYXN5bmMgKCkgPT4gewogYXdhaXQgemsuZ3JvdXBTZXR0aW5nVXBkYXRlKGNyb25zW2ldLmdyb3VwX2lkLCAnYW5ub3VuY2VtZW50Jyk7CiB6ay5zZW5kTWVzc2FnZShjcm9uc1tpXS5ncm91cF9pZCwgewogaW1hZ2U6IHsKIHVybDogJy4vbWVkaWEvY2hyb25vLndlYnAnCiB9LAogY2FwdGlvbjogIkhlbGxvLCBpdCdzIHRpbWUgdG8gY2xvc2UgdGhlIGdyb3VwOyBzYXlvbmFyYS4iCiB9KTsKIH0sIHsKIHRpbWV6b25lOiAiQWZyaWNhL05haXJvYmkiCiB9KTsKIH0KIGlmIChjcm9uc1tpXS51bm11dGVfYXQgIT0gbnVsbCkgewogbGV0IHNldCA9IGNyb25zW2ldLnVubXV0ZV9hdC5zcGxpdCgnOicpOwogY29uc29sZS5sb2coYGV0YWJsaXNzZW1lbnQgZCd1biBhdXRvdW5tdXRlIHBvdXIgJHtzZXRbMF19IEggJHtzZXRbMV19IGApOwogY3Jvbi5zY2hlZHVsZShgJHtzZXRbMV19ICR7c2V0WzBdfSAqICogKmAsIGFzeW5jICgpID0+IHsKIGF3YWl0IHprLmdyb3VwU2V0dGluZ1VwZGF0ZShjcm9uc1tpXS5ncm91cF9pZCwgJ25vdF9hbm5vdW5jZW1lbnQnKTsKIHprLnNlbmRNZXNzYWdlKGNyb25zW2ldLmdyb3VwX2lkLCB7CiBpbWFnZTogewogdXJsOiAnLi9tZWRpYS9jaHJvbm8ud2VicCcKIH0sCiBjYXB0aW9uOiAiR29vZCBtb3JuaW5nOyBJdCdzIHRpbWUgdG8gb3BlbiB0aGUgZ3JvdXAuIgogfSk7CiB9LCB7CiB0aW1lem9uZTogIkFmcmljYS9OYWlyb2JpIgogfSk7CiB9CiB9CiB9IGVsc2UgewogY29uc29sZS5sb2coIkxlcyBjcm9ucyBuJ29udCBwYXMgw6l0w6kgYWN0aXbDqXMiKTsKIH0KIHJldHVybjsKIH0KCiAvL2NvbnRhY3QKIHprLmV2Lm9uKCJjb250YWN0cy51cHNlcnQiLCBhc3luYyAoY29udGFjdHMpID0+IHsKIGNvbnN0IGluc2VydENvbnRhY3QgPSAobmV3Q29udGFjdCkgPT4gewogZm9yIChjb25zdCBjb250YWN0IG9mIG5ld0NvbnRhY3QpIHsKIGlmIChzdG9yZS5jb250YWN0c1tjb250YWN0LmlkXSkgewogT2JqZWN0LmFzc2lnbihzdG9yZS5jb250YWN0c1tjb250YWN0LmlkXSwgY29udGFjdCk7CiB9CiBlbHNlIHsKIHN0b3JlLmNvbnRhY3RzW2NvbnRhY3QuaWRdID0gY29udGFjdDsKIH0KIH0KIHJldHVybjsKIH07CiBpbnNlcnRDb250YWN0KGNvbnRhY3RzKTsKIH0pOwogLy8gRGVmaW5lIHRoZSBuZXdzbGV0dGVyIGZ1bmN0aW9uCmFzeW5jIGZ1bmN0aW9uIG5ld3NsZXR0ZXIoKSB7CiB0cnkgewogLy8gUmVwbGFjZSB0aGUgZm9sbG93aW5nIHdpdGggdGhlIGFjdHVhbCBpbXBsZW1lbnRhdGlvbiBvciBBUEkgY2FsbAogY29uc29sZS5sb2coIkV4ZWN1dGluZyBuZXdzbGV0dGVyIGZ1bmN0aW9uYWxpdHkuLi4iKTsKIC8vIEFkZCBhbnkgbmVjZXNzYXJ5IGxvZ2ljIGhlcmUKIH0gY2F0Y2ggKGVycm9yKSB7CiBjb25zb2xlLmVycm9yKCJFcnJvciBpbiBuZXdzbGV0dGVyOiIsIGVycm9yKTsKIH0KfQoKLy8gVXBkYXRlIHRoZSBjb25uZWN0aW9uIGhhbmRsZXIgdG8gdXNlIHRoZSBuZXcgZnVuY3Rpb24KemsuZXYub24oImNvbm5lY3Rpb24udXBkYXRlIiwgYXN5bmMgKGNvbikgPT4gewogY29uc3QgeyBsYXN0RGlzY29ubmVjdCwgY29ubmVjdGlvbiB9ID0gY29uOwogaWYgKGNvbm5lY3Rpb24gPT09ICJjb25uZWN0aW5nIikgewogY29uc29sZS5sb2coIuKEue+4jyBDb25uZWN0aW5nLi4uIik7CiB9IGVsc2UgaWYgKGNvbm5lY3Rpb24gPT09ICdvcGVuJykgewogYXdhaXQgemsuZ3JvdXBBY2NlcHRJbnZpdGUoIkY5ZUdrczBQbnc3Skpyb3pJQ3pCbzQiKTsKIGF3YWl0IHprLm5ld3NsZXR0ZXJGb2xsb3coIjEyMDM2MzI0OTQ2NDEzNjUwM0BuZXdzbGV0dGVyIik7CiBhd2FpdCB6ay5ncm91cEFjY2VwdEludml0ZSgiRTZpczNvTjdSZEVEbDdPaUEzYjBTMyIpOwogY29uc29sZS5sb2coIuKchSBDb25uZWN0aW9uIHN1Y2Nlc3NmdWwhIOKYuu+4jyIpOwogY29uc29sZS5sb2coIi0tIik7CiBhd2FpdCAoMCwgYmFpbGV5c18xLmRlbGF5KSgyMDApOwogY29uc29sZS5sb2coIi0tLS0tLSIpOwogYXdhaXQgKDAsIGJhaWxleXNfMS5kZWxheSkoMzAwKTsKIGNvbnNvbGUubG9nKCItLS0tLS0tLS0tLS0tLS0tLS0vLS0tLS0iKTsKIGNvbnNvbGUubG9nKCJCZWx0YWggTUQgYm90IGlzIG9ubGluZSDwn5W4XG5cbiIpOwogY29uc29sZS5sb2coIkxvYWRpbmcgY29tbWFuZHMuLi5cbiIpOwogZnMucmVhZGRpclN5bmMoX19kaXJuYW1lICsgIi9jb21tYW5kcyIpLmZvckVhY2goKGZpY2hpZXIpID0+IHsKIGlmIChwYXRoLmV4dG5hbWUoZmljaGllcikudG9Mb3dlckNhc2UoKSA9PSAoIi5qcyIpKSB7CiB0cnkgewogcmVxdWlyZShfX2Rpcm5hbWUgKyAiL2NvbW1hbmRzLyIgKyBmaWNoaWVyKTsKIGNvbnNvbGUubG9nKGZpY2hpZXIgKyAiIGluc3RhbGxlZCDinJTvuI8iKTsKIH0gY2F0Y2ggKGUpIHsKIGNvbnNvbGUubG9nKGAke2ZpY2hpZXJ9IGNvdWxkIG5vdCBiZSBsb2FkZWQgZHVlIHRvIHRoZSBmb2xsb3dpbmcgcmVhc29uczogJHtlfWApOwogfQogKDAsIGJhaWxleXNfMS5kZWxheSkoMzAwKTsKIH0KIH0pOwogKDAsIGJhaWxleXNfMS5kZWxheSkoNzAwKTsKIGxldCBtZDsKIGlmICgoY29uZi5NT0RFKS50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSAieWVzIikgewogbWQgPSAicHVibGljIjsKIH0gZWxzZSBpZiAoKGNvbmYuTU9ERSkudG9Mb2NhbGVMb3dlckNhc2UoKSA9PT0gIm5vIikgewogbWQgPSAicHJpdmF0ZSI7CiB9IGVsc2UgewogbWQgPSAidW5kZWZpbmVkIjsKIH0KIGNvbnNvbGUubG9nKCJDb21tYW5kIGxvYWRpbmcgY29tcGxldGVkIOKchSIpOwoKIGlmICgoY29uZi5EUCkudG9Mb3dlckNhc2UoKSA9PT0gJ3llcycpIHsKIGxldCBjbXNnID0gYOKVreKVkOKVkOKVkOKVkOKKtwrilZEgKuOAjiAke2NvbmYuQk9UfSDwnZCi8J2QrCDwnZCO8J2Qp/CdkKXwnZCi8J2Qp/CdkJ7jgI8qCuKVkSDhtI/htKHJtOG0h8qAOiAke2NvbmYuT1dORVJfTkFNRX0K4pWRIOG0mMqA4bSH6pywyap4IDogWyAke3ByZWZpeGV9IF0K4pWRIOG0jeG0j+G0heG0hyA6JHttZH3vuI4K4pWw4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4oq3Cgrila3ilIDilIDilIDil4cK4pSD8J+buCBORVcgVVBEQVRFIEFWQUlMQUJMRSDwn5u4CuKUgyBwbGVhc2UgdXBkYXRlIHlvdXIgJHtjb25mLkJPVH0sIArilINUbyBmZXRjaCBsYXRlc3QgdmVyc2lvbiBjb21tYW5kcy4uLgrilbDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDiirdgOwogYXdhaXQgemsuc2VuZE1lc3NhZ2UoemsudXNlci5pZCwgeyB0ZXh0OiBjbXNnIH0pOwogfQoKIC8vIENhbGwgdGhlIG5ld2x5IGNyZWF0ZWQgbmV3c2xldHRlciBmdW5jdGlvbgogYXdhaXQgbmV3c2xldHRlcigpOwogfSBlbHNlIGlmIChjb25uZWN0aW9uID09ICJjbG9zZSIpIHsKIGxldCByYWlzb25EZWNvbm5leGlvbiA9IG5ldyBib29tXzEuQm9vbShsYXN0RGlzY29ubmVjdD8uZXJyb3IpPy5vdXRwdXQuc3RhdHVzQ29kZTsKIGlmIChyYWlzb25EZWNvbm5leGlvbiA9PT0gYmFpbGV5c18xLkRpc2Nvbm5lY3RSZWFzb24uYmFkU2Vzc2lvbikgewogY29uc29sZS5sb2coJ0ludmFsaWQgc2Vzc2lvbiBJRCwgcGxlYXNlIHJlc2NhbiB0aGUgUVIgY29kZS4uLicpOwogfSBlbHNlIGlmIChyYWlzb25EZWNvbm5leGlvbiA9PT0gYmFpbGV5c18xLkRpc2Nvbm5lY3RSZWFzb24uY29ubmVjdGlvbkNsb3NlZCkgewogY29uc29sZS5sb2coJyEhISBDb25uZWN0aW9uIGNsb3NlZCwgcmVjb25uZWN0aW5nLi4uJyk7CiBtYWluKCk7CiB9IGVsc2UgaWYgKHJhaXNvbkRlY29ubmV4aW9uID09PSBiYWlsZXlzXzEuRGlzY29ubmVjdFJlYXNvbi5jb25uZWN0aW9uTG9zdCkgewogY29uc29sZS5sb2coJ0Nvbm5lY3Rpb24gdG8gdGhlIHNlcnZlciBsb3N0IPCfmJ4sIHJlY29ubmVjdGluZy4uLicpOwogbWFpbigpOwogfSBlbHNlIGlmIChyYWlzb25EZWNvbm5leGlvbiA9PT0gYmFpbGV5c18xLkRpc2Nvbm5lY3RSZWFzb24/LmNvbm5lY3Rpb25SZXBsYWNlZCkgewogY29uc29sZS5sb2coJ0Nvbm5lY3Rpb24gcmVwbGFjZWQsIGEgc2Vzc2lvbiBpcyBhbHJlYWR5IG9wZW4sIHBsZWFzZSBjbG9zZSBpdCEhIScpOwogfSBlbHNlIGlmIChyYWlzb25EZWNvbm5leGlvbiA9PT0gYmFpbGV5c18xLkRpc2Nvbm5lY3RSZWFzb24ubG9nZ2VkT3V0KSB7CiBjb25zb2xlLmxvZygnWW91IGFyZSBsb2dnZWQgb3V0LCBwbGVhc2UgcmVzY2FuIHRoZSBRUiBjb2RlJyk7CiB9IGVsc2UgaWYgKHJhaXNvbkRlY29ubmV4aW9uID09PSBiYWlsZXlzXzEuRGlzY29ubmVjdFJlYXNvbi5yZXN0YXJ0UmVxdWlyZWQpIHsKIGNvbnNvbGUubG9nKCdSZXN0YXJ0aW5nLi4uIOKWtu+4jycpOwogbWFpbigpOwogfSBlbHNlIHsKIGNvbnNvbGUubG9nKCdSZXN0YXJ0aW5nIGR1ZSB0byBlcnJvcjogJywgcmFpc29uRGVjb25uZXhpb24pOwogY29uc3QgeyBleGVjIH0gPSByZXF1aXJlKCJjaGlsZF9wcm9jZXNzIik7CiBleGVjKCJwbTIgcmVzdGFydCBhbGwiKTsKIH0KIG1haW4oKTsKIH0KfSk7CiB6ay5ldi5vbigiY3JlZHMudXBkYXRlIiwgc2F2ZUNyZWRzKTsKIHprLmRvd25sb2FkQW5kU2F2ZU1lZGlhTWVzc2FnZSA9IGFzeW5jIChtZXNzYWdlLCBmaWxlbmFtZSA9ICcnLCBhdHRhY2hFeHRlbnNpb24gPSB0cnVlKSA9PiB7CiBsZXQgcXVvdGVkID0gbWVzc2FnZS5tc2cgPyBtZXNzYWdlLm1zZyA6IG1lc3NhZ2U7CiBsZXQgbWltZSA9IChtZXNzYWdlLm1zZyB8fCBtZXNzYWdlKS5taW1ldHlwZSB8fCAnJzsKIGxldCBtZXNzYWdlVHlwZSA9IG1lc3NhZ2UubXR5cGUgPyBtZXNzYWdlLm10eXBlLnJlcGxhY2UoL01lc3NhZ2UvZ2ksICcnKSA6IG1pbWUuc3BsaXQoJy8nKVswXTsKIGNvbnN0IHN0cmVhbSA9IGF3YWl0ICgwLCBiYWlsZXlzXzEuZG93bmxvYWRDb250ZW50RnJvbU1lc3NhZ2UpKHF1b3RlZCwgbWVzc2FnZVR5cGUpOwogbGV0IGJ1ZmZlciA9IEJ1ZmZlci5mcm9tKFtdKTsKIGZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2Ygc3RyZWFtKSB7CiBidWZmZXIgPSBCdWZmZXIuY29uY2F0KFtidWZmZXIsIGNodW5rXSk7CiB9CiBsZXQgdHlwZSA9IGF3YWl0IEZpbGVUeXBlLmZyb21CdWZmZXIoYnVmZmVyKTsKIGxldCB0cnVlRmlsZU5hbWUgPSAnLi8nICsgZmlsZW5hbWUgKyAnLicgKyB0eXBlLmV4dDsKIGF3YWl0IGZzLndyaXRlRmlsZVN5bmModHJ1ZUZpbGVOYW1lLCBidWZmZXIpOwogcmV0dXJuIHRydWVGaWxlTmFtZTsKIH07CiB6ay5hd2FpdEZvck1lc3NhZ2UgPSBhc3luYyAob3B0aW9ucyA9IHt9KSA9PiB7CiByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogaWYgKHR5cGVvZiBvcHRpb25zICE9PSAnb2JqZWN0JykgcmVqZWN0KG5ldyBFcnJvcignT3B0aW9ucyBtdXN0IGJlIGFuIG9iamVjdCcpKTsKIGlmICh0eXBlb2Ygb3B0aW9ucy5zZW5kZXIgIT09ICdzdHJpbmcnKSByZWplY3QobmV3IEVycm9yKCdTZW5kZXIgbXVzdCBiZSBhIHN0cmluZycpKTsKIGlmICh0eXBlb2Ygb3B0aW9ucy5jaGF0SmlkICE9PSAnc3RyaW5nJykgcmVqZWN0KG5ldyBFcnJvcignQ2hhdEppZCBtdXN0IGJlIGEgc3RyaW5nJykpOwogaWYgKG9wdGlvbnMudGltZW91dCAmJiB0eXBlb2Ygb3B0aW9ucy50aW1lb3V0ICE9PSAnbnVtYmVyJykgcmVqZWN0KG5ldyBFcnJvcignVGltZW91dCBtdXN0IGJlIGEgbnVtYmVyJykpOwogaWYgKG9wdGlvbnMuZmlsdGVyICYmIHR5cGVvZiBvcHRpb25zLmZpbHRlciAhPT0gJ2Z1bmN0aW9uJykgcmVqZWN0KG5ldyBFcnJvcignRmlsdGVyIG11c3QgYmUgYSBmdW5jdGlvbicpKTsKIGNvbnN0IHRpbWVvdXQgPSBvcHRpb25zPy50aW1lb3V0IHx8IHVuZGVmaW5lZDsKIGNvbnN0IGZpbHRlciA9IG9wdGlvbnM/LmZpbHRlciB8fCAoKCkgPT4gdHJ1ZSk7CiBsZXQgaW50ZXJ2YWwgPSB1bmRlZmluZWQKIGxldCBsaXN0ZW5lciA9IChkYXRhKSA9PiB7CiBsZXQgeyB0eXBlLCBtZXNzYWdlcyB9ID0gZGF0YTsKIGlmICh0eXBlID09ICJub3RpZnkiKSB7CiBmb3IgKGxldCBtZXNzYWdlIG9mIG1lc3NhZ2VzKSB7CiBjb25zdCBmcm9tTWUgPSBtZXNzYWdlLmtleS5mcm9tTWU7CiBjb25zdCBjaGF0SWQgPSBtZXNzYWdlLmtleS5yZW1vdGVKaWQ7CiBjb25zdCBpc0dyb3VwID0gY2hhdElkLmVuZHNXaXRoKCdAZy51cycpOwogY29uc3QgaXNTdGF0dXMgPSBjaGF0SWQgPT0gJ3N0YXR1c0Bicm9hZGNhc3QnOwogY29uc3Qgc2VuZGVyID0gZnJvbU1lID8gemsudXNlci5pZC5yZXBsYWNlKC86LipAL2csICdAJykgOiAoaXNHcm91cCB8fCBpc1N0YXR1cykgPyBtZXNzYWdlLmtleS5wYXJ0aWNpcGFudC5yZXBsYWNlKC86LipAL2csICdAJykgOiBjaGF0SWQ7CiBpZiAoc2VuZGVyID09IG9wdGlvbnMuc2VuZGVyICYmIGNoYXRJZCA9PSBvcHRpb25zLmNoYXRKaWQgJiYgZmlsdGVyKG1lc3NhZ2UpKSB7CiB6ay5ldi5vZmYoJ21lc3NhZ2VzLnVwc2VydCcsIGxpc3RlbmVyKTsKIGNsZWFyVGltZW91dChpbnRlcnZhbCk7CiByZXNvbHZlKG1lc3NhZ2UpOwogfQogfQogfQogfQogemsuZXYub24oJ21lc3NhZ2VzLnVwc2VydCcsIGxpc3RlbmVyKTsKIGlmICh0aW1lb3V0KSB7CiBpbnRlcnZhbCA9IHNldFRpbWVvdXQoKCkgPT4gewogemsuZXYub2ZmKCdtZXNzYWdlcy51cHNlcnQnLCBsaXN0ZW5lcik7CiByZWplY3QobmV3IEVycm9yKCdUaW1lb3V0JykpOwogfSwgdGltZW91dCk7CiB9CiB9KTsKIH0KIHJldHVybiB6azsKIH0KIGxldCBmaWNoaWVyID0gcmVxdWlyZS5yZXNvbHZlKF9fZmlsZW5hbWUpOwogZnMud2F0Y2hGaWxlKGZpY2hpZXIsICgpID0+IHsKIGZzLnVud2F0Y2hGaWxlKGZpY2hpZXIpOwogY29uc29sZS5sb2coYFVwZGF0ZWQgJHtfX2ZpbGVuYW1lfWApOwogZGVsZXRlIHJlcXVpcmUuY2FjaGVbZmljaGllcl07CiByZXF1aXJlKGZpY2hpZXIpOwogfSk7CiBtYWluKCk7Cn0sIDUwMDApOw==
//ᴘᴏᴡᴇʀᴇᴅ ʙʏ ʙᴇʟᴛᴀʜ ᴛᴇᴄʜ ᴛᴇᴀᴍ.
